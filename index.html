<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>JobPulse — Job Market Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg: #0f1117; --bg-card: #1a1d27; --bg-hover: #232733;
      --text: #e4e6ec; --text-muted: #8b8fa3;
      --accent: #6366f1; --accent-light: #818cf8;
      --green: #22c55e; --orange: #f97316; --red: #ef4444;
      --border: #2a2d3a; --radius: 12px;
    }
    body { background: var(--bg); color: var(--text); font-family: 'Inter', -apple-system, sans-serif; line-height: 1.6; }

    header { background: linear-gradient(135deg, #1e1b4b 0%, #0f1117 100%); border-bottom: 1px solid var(--border); padding: 2.5rem 2rem 2rem; text-align: center; }
    .logo { font-size: 2.2rem; font-weight: 800; background: linear-gradient(135deg, var(--accent-light), var(--green)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .tagline { color: var(--text-muted); margin: 0.25rem 0 0.5rem; font-size: 0.95rem; }
    .header-meta { color: var(--text-muted); font-size: 0.8rem; margin-top: 0.5rem; }
    .header-meta span { color: var(--accent-light); font-weight: 600; }

    main { max-width: 1200px; margin: 0 auto; padding: 1.5rem; }
    .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 1.5rem; }
    .card h2 { font-size: 1rem; color: var(--text-muted); margin-bottom: 1rem; font-weight: 600; }

    .insights-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.5rem; }
    .stat-card { text-align: center; padding: 1.25rem; }
    .stat-label { display: block; font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.3rem; }
    .stat-value { display: block; font-size: 1.8rem; font-weight: 800; color: var(--accent-light); }

    .charts-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem; }
    .chart-card { min-height: 280px; }
    .chart-card canvas { max-height: 240px; }

    .filters-bar { display: flex; gap: 0.75rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
    .filters-bar input, .filters-bar select {
      padding: 0.6rem 0.9rem; background: var(--bg-card); border: 1px solid var(--border);
      border-radius: 8px; color: var(--text); font-size: 0.9rem; flex: 1; min-width: 140px;
    }
    .filters-bar input::placeholder { color: var(--text-muted); }

    .btn { padding: 0.6rem 1.4rem; border: none; border-radius: 8px; font-weight: 600; font-size: 0.9rem; cursor: pointer; transition: background 0.2s, transform 0.1s; }
    .btn:active { transform: scale(0.97); }
    .btn-primary { background: var(--accent); color: white; }
    .btn-primary:hover { background: var(--accent-light); }
    .btn-secondary { background: var(--bg-hover); color: var(--text); border: 1px solid var(--border); }
    .btn-secondary:hover { background: var(--border); }
    .btn-sm { padding: 0.35rem 0.9rem; font-size: 0.8rem; background: var(--bg-hover); color: var(--text); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; }
    .btn-sm:disabled { opacity: 0.4; cursor: default; }

    .table-card { overflow: hidden; }
    .table-wrap { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; }
    th { text-align: left; padding: 0.75rem 1rem; font-size: 0.8rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 1px solid var(--border); }
    td { padding: 0.75rem 1rem; font-size: 0.9rem; border-bottom: 1px solid var(--border); vertical-align: top; }
    tr:hover td { background: var(--bg-hover); }
    td a { color: var(--accent-light); text-decoration: none; }
    td a:hover { text-decoration: underline; }

    .tag { display: inline-block; padding: 0.15rem 0.5rem; background: rgba(99,102,241,0.12); color: var(--accent-light); border-radius: 4px; font-size: 0.75rem; margin: 0.1rem; }
    .source-badge { padding: 0.2rem 0.6rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600; }
    .source-badge.remoteok { background: rgba(34,197,94,0.12); color: var(--green); }
    .source-badge.arbeitnow { background: rgba(99,102,241,0.12); color: var(--accent-light); }

    .pagination { display: flex; align-items: center; justify-content: center; gap: 1rem; padding: 1rem; }
    #page-info { font-size: 0.85rem; color: var(--text-muted); }

    footer { text-align: center; padding: 2rem; color: var(--text-muted); font-size: 0.8rem; border-top: 1px solid var(--border); margin-top: 2rem; }
    footer a { color: var(--accent-light); text-decoration: none; }

    .loading { text-align: center; padding: 3rem; color: var(--text-muted); }
    .loading::after { content: ''; display: inline-block; width: 18px; height: 18px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.6s linear infinite; margin-left: 0.5rem; vertical-align: middle; }
    @keyframes spin { to { transform: rotate(360deg); } }

    @media (max-width: 768px) {
      .insights-row { grid-template-columns: repeat(2, 1fr); }
      .charts-row { grid-template-columns: 1fr; }
      .filters-bar { flex-direction: column; }
    }
    @media (max-width: 480px) {
      .insights-row { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

<header>
  <h1 class="logo">JobPulse</h1>
  <p class="tagline">Real-time job market intelligence</p>
  <p class="header-meta">Live data from <span>RemoteOK</span> and <span>Arbeitnow</span> &mdash; powered by Supabase</p>
</header>

<main>
  <section class="insights-row">
    <div class="card stat-card" id="stat-total">
      <span class="stat-label">Active Listings</span>
      <span class="stat-value">—</span>
    </div>
    <div class="card stat-card" id="stat-sources">
      <span class="stat-label">Sources</span>
      <span class="stat-value">—</span>
    </div>
    <div class="card stat-card" id="stat-companies">
      <span class="stat-label">Companies</span>
      <span class="stat-value">—</span>
    </div>
    <div class="card stat-card" id="stat-latest">
      <span class="stat-label">Last Scrape</span>
      <span class="stat-value">—</span>
    </div>
  </section>

  <section class="charts-row">
    <div class="card chart-card">
      <h2>Top Skills / Tags</h2>
      <canvas id="tags-chart"></canvas>
    </div>
    <div class="card chart-card">
      <h2>Salary Distribution</h2>
      <canvas id="salary-chart"></canvas>
    </div>
  </section>

  <section class="charts-row">
    <div class="card chart-card">
      <h2>Top Hiring Companies</h2>
      <canvas id="companies-chart"></canvas>
    </div>
    <div class="card chart-card">
      <h2>Scrape History</h2>
      <canvas id="history-chart"></canvas>
    </div>
  </section>

  <section class="filters-bar">
    <input type="text" id="filter-role" placeholder="Role keyword..." />
    <input type="text" id="filter-location" placeholder="Location..." />
    <input type="number" id="filter-salary" placeholder="Min salary..." />
    <select id="filter-source">
      <option value="">All Sources</option>
      <option value="remoteok">RemoteOK</option>
      <option value="arbeitnow">Arbeitnow</option>
    </select>
    <button id="filter-btn" class="btn btn-secondary">Filter</button>
  </section>

  <section class="card table-card">
    <h2>Job Listings</h2>
    <div class="table-wrap">
      <table id="jobs-table">
        <thead>
          <tr>
            <th>Title</th>
            <th>Company</th>
            <th>Location</th>
            <th>Salary</th>
            <th>Tags</th>
            <th>Source</th>
          </tr>
        </thead>
        <tbody><tr><td colspan="6" class="loading">Loading listings</td></tr></tbody>
      </table>
    </div>
    <div class="pagination">
      <button id="prev-page" class="btn btn-sm" disabled>Prev</button>
      <span id="page-info">Page 1</span>
      <button id="next-page" class="btn btn-sm">Next</button>
    </div>
  </section>
</main>

<footer>
  <p>JobPulse &mdash; Engineering portfolio demo &mdash; <a href="https://github.com/AntoineKoerber/JobPulse">View Source on GitHub</a></p>
</footer>

<script>
(() => {
  'use strict';

  const SUPABASE_URL = 'https://rbwfnhnuvedrljlawisq.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJid2ZuaG51dmVkcmxqbGF3aXNxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk4MzIwMzgsImV4cCI6MjA4NTQwODAzOH0.wSCGwvtKp-t8FJB6NsCKdwnJJFzHUIldAzMLxgvxL_c';

  const headers = {
    'apikey': SUPABASE_ANON_KEY,
    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
  };

  function api(table, params = '') {
    return fetch(`${SUPABASE_URL}/rest/v1/${table}?${params}`, { headers });
  }

  function apiCount(table, params = '') {
    return fetch(`${SUPABASE_URL}/rest/v1/${table}?${params}`, {
      headers: { ...headers, 'Prefer': 'count=exact', 'Range': '0-0' },
    });
  }

  let currentPage = 1;
  const pageSize = 50;
  let tagsChart, salaryChart, companiesChart, historyChart;

  // ── Filters ───────────────────────────────────
  document.getElementById('filter-btn').addEventListener('click', () => { currentPage = 1; loadJobs(); });
  document.getElementById('prev-page').addEventListener('click', () => { if (currentPage > 1) { currentPage--; loadJobs(); } });
  document.getElementById('next-page').addEventListener('click', () => { currentPage++; loadJobs(); });

  // ── Load Jobs ─────────────────────────────────
  async function loadJobs() {
    const role = document.getElementById('filter-role').value.trim();
    const location = document.getElementById('filter-location').value.trim();
    const salary = document.getElementById('filter-salary').value;
    const source = document.getElementById('filter-source').value;

    let filters = 'is_active=eq.true&order=last_seen.desc';
    if (source) filters += `&source=eq.${source}`;
    if (location) filters += `&location=ilike.*${encodeURIComponent(location)}*`;
    if (role) filters += `&or=(title.ilike.*${encodeURIComponent(role)}*,tags.cs.["${role}"])`;
    if (salary) filters += `&salary_min=gte.${salary}`;

    const offset = (currentPage - 1) * pageSize;

    try {
      const res = await fetch(
        `${SUPABASE_URL}/rest/v1/job_listings?${filters}&select=id,external_id,source,title,company,location,salary_min,salary_max,currency,tags,url,posted_at,first_seen,last_seen,quality_score`,
        { headers: { ...headers, 'Prefer': 'count=exact', 'Range': `${offset}-${offset + pageSize - 1}` } }
      );
      const listings = await res.json();
      const total = parseInt(res.headers.get('content-range')?.split('/')[1] || '0');

      renderTable(listings);
      updatePagination(total, currentPage);
      document.querySelector('#stat-total .stat-value').textContent = total.toLocaleString();
    } catch (e) {
      console.error('Failed to load jobs:', e);
    }
  }

  function renderTable(listings) {
    const tbody = document.querySelector('#jobs-table tbody');
    if (!listings.length) {
      tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--text-muted)">No listings found</td></tr>';
      return;
    }
    tbody.innerHTML = listings.map(job => `
      <tr>
        <td>${job.url ? `<a href="${job.url}" target="_blank" rel="noopener">${esc(job.title)}</a>` : esc(job.title)}</td>
        <td>${esc(job.company)}</td>
        <td>${esc(job.location || '—')}</td>
        <td>${formatSalary(job.salary_min, job.salary_max, job.currency)}</td>
        <td>${(job.tags || []).slice(0, 4).map(t => `<span class="tag">${esc(t)}</span>`).join('')}</td>
        <td><span class="source-badge ${job.source}">${job.source}</span></td>
      </tr>
    `).join('');
  }

  function updatePagination(total, page) {
    const maxPage = Math.max(1, Math.ceil(total / pageSize));
    document.getElementById('page-info').textContent = `Page ${page} of ${maxPage}`;
    document.getElementById('prev-page').disabled = page <= 1;
    document.getElementById('next-page').disabled = page >= maxPage;
  }

  function formatSalary(min, max, currency) {
    if (!min && !max) return '—';
    const fmt = n => `${(n / 1000).toFixed(0)}k`;
    const sym = currency === 'EUR' ? '\u20ac' : currency === 'GBP' ? '\u00a3' : '$';
    if (min && max && min !== max) return `${sym}${fmt(min)} - ${sym}${fmt(max)}`;
    return `${sym}${fmt(min || max)}`;
  }

  function esc(str) {
    if (!str) return '';
    const d = document.createElement('div');
    d.textContent = str;
    return d.innerHTML;
  }

  // ── Load Insights ─────────────────────────────
  async function loadInsights() {
    try {
      // All active listings for tag/salary/company aggregation
      const res = await api('job_listings', 'is_active=eq.true&select=tags,salary_min,salary_max,company,source');
      const listings = await res.json();

      // Top tags
      const tagCounts = {};
      listings.forEach(l => {
        (l.tags || []).forEach(t => { const k = t.toLowerCase(); tagCounts[k] = (tagCounts[k] || 0) + 1; });
      });
      const topTags = Object.entries(tagCounts).sort((a, b) => b[1] - a[1]).slice(0, 15);
      renderTagsChart(topTags);

      // Salary distribution
      const buckets = { '0-50k': 0, '50k-80k': 0, '80k-120k': 0, '120k-160k': 0, '160k-200k': 0, '200k+': 0 };
      listings.forEach(l => {
        const s = l.salary_min || l.salary_max;
        if (!s) return;
        if (s < 50000) buckets['0-50k']++;
        else if (s < 80000) buckets['50k-80k']++;
        else if (s < 120000) buckets['80k-120k']++;
        else if (s < 160000) buckets['120k-160k']++;
        else if (s < 200000) buckets['160k-200k']++;
        else buckets['200k+']++;
      });
      renderSalaryChart(buckets);

      // Top companies
      const companyCounts = {};
      listings.forEach(l => { companyCounts[l.company] = (companyCounts[l.company] || 0) + 1; });
      const topCompanies = Object.entries(companyCounts).sort((a, b) => b[1] - a[1]).slice(0, 12);
      renderCompaniesChart(topCompanies);

      // Sources
      const sources = new Set(listings.map(l => l.source));
      document.querySelector('#stat-sources .stat-value').textContent = sources.size;

      // Unique companies
      document.querySelector('#stat-companies .stat-value').textContent = Object.keys(companyCounts).length.toLocaleString();

      // Scrape history
      const histRes = await api('scrape_runs', 'status=eq.completed&order=started_at.desc&limit=30&select=source,started_at,quality_score,total_count,added_count,removed_count');
      const history = await histRes.json();
      renderHistoryChart(history);

      if (history.length > 0) {
        const d = new Date(history[0].started_at);
        document.querySelector('#stat-latest .stat-value').textContent =
          d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
      }
    } catch (e) {
      console.error('Failed to load insights:', e);
    }
  }

  const chartColors = { grid: '#2a2d3a', text: '#8b8fa3' };
  const defaultOpts = {
    responsive: true, maintainAspectRatio: false,
    plugins: { legend: { display: false } },
    scales: {
      x: { ticks: { color: chartColors.text, font: { size: 11 } }, grid: { color: chartColors.grid } },
      y: { ticks: { color: chartColors.text, font: { size: 11 } }, grid: { color: chartColors.grid } },
    },
  };

  function renderTagsChart(tags) {
    const ctx = document.getElementById('tags-chart');
    if (tagsChart) tagsChart.destroy();
    tagsChart = new Chart(ctx, {
      type: 'bar',
      data: { labels: tags.map(t => t[0]), datasets: [{ data: tags.map(t => t[1]), backgroundColor: '#6366f1', borderRadius: 4 }] },
      options: { ...defaultOpts, indexAxis: 'y' },
    });
  }

  function renderSalaryChart(buckets) {
    const ctx = document.getElementById('salary-chart');
    if (salaryChart) salaryChart.destroy();
    salaryChart = new Chart(ctx, {
      type: 'bar',
      data: { labels: Object.keys(buckets), datasets: [{ data: Object.values(buckets), backgroundColor: '#22c55e', borderRadius: 4 }] },
      options: defaultOpts,
    });
  }

  function renderCompaniesChart(companies) {
    const ctx = document.getElementById('companies-chart');
    if (companiesChart) companiesChart.destroy();
    companiesChart = new Chart(ctx, {
      type: 'bar',
      data: { labels: companies.map(c => c[0]), datasets: [{ data: companies.map(c => c[1]), backgroundColor: '#f97316', borderRadius: 4 }] },
      options: { ...defaultOpts, indexAxis: 'y' },
    });
  }

  function renderHistoryChart(history) {
    const ctx = document.getElementById('history-chart');
    if (historyChart) historyChart.destroy();
    const sorted = [...history].reverse();
    historyChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: sorted.map(h => new Date(h.started_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })),
        datasets: [
          { label: 'Added', data: sorted.map(h => h.added_count), borderColor: '#22c55e', backgroundColor: 'rgba(34,197,94,0.1)', fill: true, tension: 0.3 },
          { label: 'Removed', data: sorted.map(h => h.removed_count), borderColor: '#ef4444', backgroundColor: 'rgba(239,68,68,0.1)', fill: true, tension: 0.3 },
        ],
      },
      options: { ...defaultOpts, plugins: { legend: { display: true, labels: { color: chartColors.text } } } },
    });
  }

  // ── Init ───────────────────────────────────────
  loadJobs();
  loadInsights();
})();
</script>
</body>
</html>
