<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>JobPulse — Job Market Intelligence</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --bg-base: #09090b;
      --bg-surface: #111114;
      --bg-card: #18181b;
      --bg-elevated: #1f1f23;
      --bg-hover: #27272a;
      --text-primary: #fafafa;
      --text-secondary: #a1a1aa;
      --text-tertiary: #71717a;
      --border: rgba(255,255,255,0.06);
      --border-subtle: rgba(255,255,255,0.04);
      --accent: #6366f1;
      --accent-glow: rgba(99,102,241,0.15);
      --green: #22c55e;
      --green-glow: rgba(34,197,94,0.12);
      --orange: #f97316;
      --orange-glow: rgba(249,115,22,0.12);
      --red: #ef4444;
      --cyan: #06b6d4;
      --cyan-glow: rgba(6,182,212,0.12);
      --radius: 16px;
      --radius-sm: 10px;
      --shadow: 0 1px 3px rgba(0,0,0,0.4), 0 8px 24px rgba(0,0,0,0.25);
    }

    body {
      background: var(--bg-base);
      color: var(--text-primary);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
    }

    /* ── Hero Header ─────────────────────────────── */
    .hero {
      position: relative;
      overflow: hidden;
      padding: 3.5rem 2rem 3rem;
      background: var(--bg-surface);
      border-bottom: 1px solid var(--border);
    }
    .hero::before {
      content: '';
      position: absolute;
      top: -40%; left: -10%;
      width: 60%; height: 200%;
      background: radial-gradient(ellipse, rgba(99,102,241,0.08) 0%, transparent 70%);
      pointer-events: none;
    }
    .hero::after {
      content: '';
      position: absolute;
      top: -30%; right: -5%;
      width: 40%; height: 180%;
      background: radial-gradient(ellipse, rgba(34,197,94,0.06) 0%, transparent 70%);
      pointer-events: none;
    }
    .hero-inner {
      max-width: 1280px;
      margin: 0 auto;
      position: relative;
      z-index: 1;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 2rem;
    }
    .hero-left { flex: 1; }
    .hero-right {
      flex-shrink: 0;
      width: 280px;
    }
    .hero-widget {
      background: rgba(255,255,255,0.03);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1.5rem;
      backdrop-filter: blur(12px);
    }
    .hero-widget-title {
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-tertiary);
      margin-bottom: 1rem;
    }
    .hero-widget-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.55rem 0;
      border-bottom: 1px solid var(--border-subtle);
    }
    .hero-widget-row:last-child { border-bottom: none; }
    .hero-widget-row .hw-label {
      font-size: 0.82rem;
      color: var(--text-secondary);
    }
    .hero-widget-row .hw-value {
      font-size: 0.85rem;
      font-weight: 700;
      color: var(--text-primary);
    }
    .hw-value.green { color: var(--green); }
    .hw-value.accent { color: #818cf8; }
    .hw-value.orange { color: var(--orange); }
    .hw-value.cyan { color: var(--cyan); }
    @media (max-width: 900px) {
      .hero-inner { flex-direction: column; align-items: flex-start; }
      .hero-right { width: 100%; }
    }
    .hero-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.35rem 0.9rem;
      background: var(--accent-glow);
      border: 1px solid rgba(99,102,241,0.2);
      border-radius: 100px;
      font-size: 0.75rem;
      font-weight: 600;
      color: #a5b4fc;
      margin-bottom: 1rem;
      letter-spacing: 0.02em;
    }
    .hero-badge .pulse {
      width: 6px; height: 6px;
      background: var(--green);
      border-radius: 50%;
      animation: pulse 2s ease-in-out infinite;
    }
    @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.3; } }
    .hero h1 {
      font-size: 2.75rem;
      font-weight: 900;
      letter-spacing: -0.03em;
      line-height: 1.1;
      margin-bottom: 0.5rem;
    }
    .hero h1 .gradient {
      background: linear-gradient(135deg, #818cf8 0%, #6ee7b7 50%, #818cf8 100%);
      background-size: 200% auto;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: shimmer 4s ease-in-out infinite;
    }
    @keyframes shimmer { 0%,100% { background-position: 0% center; } 50% { background-position: 200% center; } }
    .hero-sub {
      font-size: 1.05rem;
      color: var(--text-secondary);
      max-width: 520px;
    }
    .hero-sources {
      display: flex;
      gap: 0.5rem;
      margin-top: 1.25rem;
      flex-wrap: wrap;
    }
    .source-pill {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.3rem 0.75rem;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 100px;
      font-size: 0.78rem;
      font-weight: 500;
      color: var(--text-secondary);
    }
    .source-pill .dot { width: 7px; height: 7px; border-radius: 50%; }
    .source-pill .dot.green { background: var(--green); }
    .source-pill .dot.indigo { background: var(--accent); }

    /* ── Layout ───────────────────────────────────── */
    .container { max-width: 1280px; margin: 0 auto; padding: 1.5rem; }

    /* ── Stat Cards ───────────────────────────────── */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .stat-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1.35rem 1.5rem;
      position: relative;
      overflow: hidden;
      transition: border-color 0.2s, transform 0.2s;
    }
    .stat-card:hover {
      border-color: rgba(255,255,255,0.1);
      transform: translateY(-2px);
    }
    .stat-card .glow {
      position: absolute;
      top: 0; right: 0;
      width: 80px; height: 80px;
      border-radius: 50%;
      filter: blur(35px);
      opacity: 0.5;
      pointer-events: none;
    }
    .stat-card .icon {
      width: 36px; height: 36px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
      margin-bottom: 0.75rem;
    }
    .stat-label {
      display: block;
      font-size: 0.78rem;
      font-weight: 500;
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-bottom: 0.25rem;
    }
    .stat-value {
      font-size: 2rem;
      font-weight: 800;
      letter-spacing: -0.02em;
      line-height: 1.1;
    }
    .stat-card:nth-child(1) .icon { background: var(--accent-glow); }
    .stat-card:nth-child(1) .glow { background: var(--accent); }
    .stat-card:nth-child(1) .stat-value { color: #a5b4fc; }
    .stat-card:nth-child(2) .icon { background: var(--green-glow); }
    .stat-card:nth-child(2) .glow { background: var(--green); }
    .stat-card:nth-child(2) .stat-value { color: #86efac; }
    .stat-card:nth-child(3) .icon { background: var(--orange-glow); }
    .stat-card:nth-child(3) .glow { background: var(--orange); }
    .stat-card:nth-child(3) .stat-value { color: #fdba74; }
    .stat-card:nth-child(4) .icon { background: var(--cyan-glow); }
    .stat-card:nth-child(4) .glow { background: var(--cyan); }
    .stat-card:nth-child(4) .stat-value { color: #67e8f9; }

    /* ── Cards ─────────────────────────────────────── */
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1.5rem;
      box-shadow: var(--shadow);
    }
    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
    }
    .card-title {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text-secondary);
    }
    .card-badge {
      font-size: 0.7rem;
      font-weight: 600;
      padding: 0.2rem 0.6rem;
      background: var(--bg-elevated);
      border-radius: 6px;
      color: var(--text-tertiary);
    }

    /* ── Charts Grid ──────────────────────────────── */
    .charts-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .chart-card { min-height: 300px; }
    .chart-card canvas { max-height: 250px; }

    /* ── Source Breakdown (Doughnut) ───────────────── */
    .insight-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .doughnut-wrap {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .doughnut-wrap canvas { max-width: 200px; max-height: 200px; }
    .insight-list { list-style: none; }
    .insight-list li {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.55rem 0;
      border-bottom: 1px solid var(--border-subtle);
      font-size: 0.85rem;
    }
    .insight-list li:last-child { border-bottom: none; }
    .insight-list .rank {
      width: 1.4rem;
      height: 1.4rem;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-elevated);
      border-radius: 6px;
      font-size: 0.68rem;
      font-weight: 700;
      color: var(--text-tertiary);
      flex-shrink: 0;
    }
    .insight-list li:nth-child(1) .rank { background: rgba(99,102,241,0.15); color: #a5b4fc; }
    .insight-list li:nth-child(2) .rank { background: rgba(34,197,94,0.12); color: #86efac; }
    .insight-list li:nth-child(3) .rank { background: rgba(249,115,22,0.12); color: #fdba74; }
    .insight-list .label { color: var(--text-secondary); flex: 1; margin-left: 0.6rem; }
    .insight-list .value { font-weight: 700; color: var(--text-primary); }

    /* ── Filters ───────────────────────────────────── */
    .filter-section {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1.25rem;
      margin-bottom: 1.5rem;
    }
    .filter-row {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 1rem;
    }
    .filter-row:last-child { margin-bottom: 0; }
    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    .filter-group-label {
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-tertiary);
    }
    .checkbox-group {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
    }
    .chip {
      display: inline-flex;
      align-items: center;
      padding: 0.35rem 0.7rem;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 100px;
      font-size: 0.75rem;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.15s;
      user-select: none;
    }
    .chip:hover { background: var(--bg-hover); color: var(--text-primary); }
    .chip.active { background: var(--accent-glow); border-color: rgba(99,102,241,0.3); color: #a5b4fc; }
    .chip input { display: none; }
    .filters {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
      align-items: center;
    }
    .filter-input {
      padding: 0.65rem 1rem;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text-primary);
      font-size: 0.88rem;
      font-family: inherit;
      flex: 1;
      min-width: 150px;
      transition: border-color 0.2s;
      outline: none;
    }
    .filter-input:focus { border-color: rgba(99,102,241,0.4); }
    .filter-input::placeholder { color: var(--text-tertiary); }
    select.filter-input { cursor: pointer; }
    option { background: var(--bg-card); color: var(--text-primary); }

    .btn {
      padding: 0.65rem 1.4rem;
      border: none;
      border-radius: var(--radius-sm);
      font-weight: 600;
      font-size: 0.88rem;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.15s;
    }
    .btn:active { transform: scale(0.97); }
    .btn-accent {
      background: var(--accent);
      color: white;
      box-shadow: 0 2px 8px rgba(99,102,241,0.3);
    }
    .btn-accent:hover { background: #818cf8; }
    .btn-ghost {
      background: var(--bg-elevated);
      color: var(--text-secondary);
      border: 1px solid var(--border);
    }
    .btn-ghost:hover { background: var(--bg-hover); color: var(--text-primary); }
    .btn-sm { padding: 0.4rem 1rem; font-size: 0.8rem; border-radius: 8px; }
    .btn-sm:disabled { opacity: 0.35; cursor: default; pointer-events: none; }

    /* ── Job Listings ─────────────────────────────────── */
    .table-section { margin-bottom: 1.5rem; }
    .jobs-list { display: flex; flex-direction: column; gap: 0.5rem; }

    .job-card {
      display: grid;
      grid-template-columns: 1fr auto auto;
      gap: 1rem;
      align-items: center;
      padding: 1rem 1.25rem;
      background: var(--bg-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 0.15s ease;
      text-decoration: none;
    }
    .job-card:hover {
      background: var(--bg-hover);
      border-color: var(--border);
      transform: translateX(4px);
    }
    .job-card:hover .job-arrow { opacity: 1; color: var(--accent); }

    .job-main { display: flex; flex-direction: column; gap: 0.35rem; min-width: 0; }
    .job-title {
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .job-meta {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex-wrap: wrap;
    }
    .job-company {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      font-size: 0.82rem;
      font-weight: 500;
      color: var(--text-secondary);
    }
    .job-company svg { width: 14px; height: 14px; opacity: 0.6; }
    .job-location {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      font-size: 0.78rem;
      color: var(--text-tertiary);
    }
    .job-location svg { width: 12px; height: 12px; opacity: 0.5; }
    .job-tags { display: flex; gap: 0.3rem; margin-top: 0.25rem; }

    .job-salary-col {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 0.3rem;
      min-width: 100px;
    }
    .job-salary {
      font-size: 0.9rem;
      font-weight: 700;
      color: var(--green);
      white-space: nowrap;
    }
    .job-salary.none {
      font-size: 0.78rem;
      font-weight: 400;
      color: var(--text-tertiary);
    }
    .job-source {
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      font-size: 0.65rem;
      font-weight: 600;
      letter-spacing: 0.03em;
      text-transform: uppercase;
    }
    .job-source.remoteok { background: var(--green-glow); color: var(--green); }
    .job-source.arbeitnow { background: var(--accent-glow); color: #a5b4fc; }
    .job-source.jobicy { background: var(--orange-glow); color: var(--orange); }

    .job-arrow {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      color: var(--text-tertiary);
      opacity: 0.4;
      transition: all 0.15s;
    }
    .job-arrow svg { width: 18px; height: 18px; }

    .tag {
      display: inline-block;
      padding: 0.15rem 0.5rem;
      background: rgba(99,102,241,0.08);
      color: #a5b4fc;
      border-radius: 4px;
      font-size: 0.68rem;
      font-weight: 500;
    }

    .no-results {
      text-align: center;
      padding: 3rem 1rem;
      color: var(--text-tertiary);
      font-size: 0.9rem;
    }

    @media (max-width: 700px) {
      .job-card { grid-template-columns: 1fr auto; gap: 0.75rem; }
      .job-salary-col { min-width: auto; }
      .job-arrow { display: none; }
    }

    .pagination {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1rem;
      padding: 1.25rem 0 0.5rem;
    }
    #page-info { font-size: 0.82rem; color: var(--text-tertiary); font-weight: 500; }

    /* ── Footer ────────────────────────────────────── */
    footer {
      text-align: center;
      padding: 2.5rem 2rem;
      color: var(--text-tertiary);
      font-size: 0.8rem;
      border-top: 1px solid var(--border);
      margin-top: 1rem;
    }
    footer a { color: #a5b4fc; text-decoration: none; }
    footer a:hover { text-decoration: underline; }
    .footer-tech {
      display: flex;
      justify-content: center;
      gap: 1.5rem;
      margin-top: 0.6rem;
      flex-wrap: wrap;
    }
    .footer-tech span { font-weight: 500; }

    /* ── Loading ────────────────────────────────────── */
    .loading-cell {
      text-align: center;
      padding: 3rem;
      color: var(--text-tertiary);
    }
    .spinner {
      display: inline-block;
      width: 20px; height: 20px;
      border: 2px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
      margin-right: 0.5rem;
      vertical-align: middle;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ── Animate in ────────────────────────────────── */
    .fade-in {
      opacity: 0;
      transform: translateY(12px);
      animation: fadeIn 0.5s ease forwards;
    }
    @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }
    .fade-in:nth-child(1) { animation-delay: 0s; }
    .fade-in:nth-child(2) { animation-delay: 0.06s; }
    .fade-in:nth-child(3) { animation-delay: 0.12s; }
    .fade-in:nth-child(4) { animation-delay: 0.18s; }

    /* ── Responsive ────────────────────────────────── */
    @media (max-width: 900px) {
      .stats-grid { grid-template-columns: repeat(2, 1fr); }
      .charts-grid { grid-template-columns: 1fr; }
      .insight-grid { grid-template-columns: 1fr; }
      .hero h1 { font-size: 2rem; }
    }
    @media (max-width: 560px) {
      .stats-grid { grid-template-columns: 1fr; }
      .filters { flex-direction: column; }
      .hero h1 { font-size: 1.6rem; }
    }
  </style>
</head>
<body>

<!-- ── Hero ──────────────────────────────────────── -->
<section class="hero">
  <div class="hero-inner">
    <div class="hero-left">
      <div class="hero-badge"><span class="pulse"></span> Live Data</div>
      <h1>Job Market<br><span class="gradient">Intelligence</span></h1>
      <p class="hero-sub">Aggregated job listings from multiple sources with real-time analytics, trend detection, and salary insights.</p>
      <div class="hero-sources">
        <span class="source-pill"><span class="dot green"></span> RemoteOK</span>
        <span class="source-pill"><span class="dot indigo"></span> Arbeitnow</span>
        <span class="source-pill"><span class="dot" style="background:var(--orange)"></span> Jobicy</span>
        <span class="source-pill">Supabase PostgreSQL</span>
        <span class="source-pill">FastAPI Pipeline</span>
      </div>
    </div>
    <div class="hero-right">
      <div class="hero-widget">
        <div class="hero-widget-title">Pipeline Status</div>
        <div class="hero-widget-row"><span class="hw-label">Total Listings</span><span class="hw-value green" id="hw-total">—</span></div>
        <div class="hero-widget-row"><span class="hw-label">Sources Active</span><span class="hw-value accent" id="hw-sources">—</span></div>
        <div class="hero-widget-row"><span class="hw-label">Avg Quality</span><span class="hw-value cyan" id="hw-quality">—</span></div>
        <div class="hero-widget-row"><span class="hw-label">Last Refresh</span><span class="hw-value orange" id="hw-refresh">—</span></div>
      </div>
    </div>
  </div>
</section>

<div class="container">

  <!-- ── Stats ────────────────────────────────────── -->
  <section class="stats-grid">
    <div class="stat-card fade-in" id="stat-total">
      <div class="glow"></div>
      <div class="icon">&#128202;</div>
      <span class="stat-label">Active Listings</span>
      <span class="stat-value">—</span>
    </div>
    <div class="stat-card fade-in" id="stat-sources">
      <div class="glow"></div>
      <div class="icon">&#127760;</div>
      <span class="stat-label">Data Sources</span>
      <span class="stat-value">—</span>
    </div>
    <div class="stat-card fade-in" id="stat-companies">
      <div class="glow"></div>
      <div class="icon">&#127970;</div>
      <span class="stat-label">Companies</span>
      <span class="stat-value">—</span>
    </div>
    <div class="stat-card fade-in" id="stat-latest">
      <div class="glow"></div>
      <div class="icon">&#128337;</div>
      <span class="stat-label">Last Scrape</span>
      <span class="stat-value">—</span>
    </div>
  </section>

  <!-- ── Insight Row: Sources Doughnut + Top Tags + Top Companies ── -->
  <section class="insight-grid">
    <div class="card fade-in">
      <div class="card-header">
        <span class="card-title">Sources Breakdown</span>
        <span class="card-badge">Live</span>
      </div>
      <div class="doughnut-wrap">
        <canvas id="sources-doughnut"></canvas>
      </div>
    </div>
    <div class="card fade-in">
      <div class="card-header">
        <span class="card-title">Top Skills</span>
        <span class="card-badge">By frequency</span>
      </div>
      <ul class="insight-list" id="top-tags-list"></ul>
    </div>
    <div class="card fade-in">
      <div class="card-header">
        <span class="card-title">Top Companies</span>
        <span class="card-badge">Most listings</span>
      </div>
      <ul class="insight-list" id="top-companies-list"></ul>
    </div>
  </section>

  <!-- ── Charts ───────────────────────────────────── -->
  <section class="charts-grid">
    <div class="card chart-card fade-in">
      <div class="card-header">
        <span class="card-title">Salary Distribution</span>
        <span class="card-badge">USD equivalent</span>
      </div>
      <canvas id="salary-chart"></canvas>
    </div>
    <div class="card chart-card fade-in">
      <div class="card-header">
        <span class="card-title">Scrape History</span>
        <span class="card-badge">Added vs Removed</span>
      </div>
      <canvas id="history-chart"></canvas>
    </div>
  </section>

  <!-- ── Filters ──────────────────────────────────── -->
  <section class="filter-section">
    <div class="filter-row">
      <div class="filters">
        <input class="filter-input" type="text" id="filter-role" placeholder="Search by role..." />
        <input class="filter-input" type="text" id="filter-location" placeholder="Location..." />
        <input class="filter-input" type="number" id="filter-salary" placeholder="Min salary..." />
        <select class="filter-input" id="filter-source">
          <option value="">All Sources</option>
          <option value="remoteok">RemoteOK</option>
          <option value="arbeitnow">Arbeitnow</option>
          <option value="jobicy">Jobicy</option>
        </select>
        <button id="filter-btn" class="btn btn-accent">Search</button>
        <button id="clear-btn" class="btn btn-ghost">Clear</button>
      </div>
    </div>
    <div class="filter-row">
      <div class="filter-group">
        <span class="filter-group-label">Seniority</span>
        <div class="checkbox-group" id="seniority-chips">
          <label class="chip"><input type="checkbox" value="senior">Senior</label>
          <label class="chip"><input type="checkbox" value="mid">Mid-Level</label>
          <label class="chip"><input type="checkbox" value="junior">Junior</label>
          <label class="chip"><input type="checkbox" value="lead">Lead</label>
          <label class="chip"><input type="checkbox" value="manager">Manager</label>
          <label class="chip"><input type="checkbox" value="director">Director</label>
          <label class="chip"><input type="checkbox" value="staff">Staff</label>
          <label class="chip"><input type="checkbox" value="principal">Principal</label>
        </div>
      </div>
    </div>
    <div class="filter-row">
      <div class="filter-group">
        <span class="filter-group-label">Role Type</span>
        <div class="checkbox-group" id="role-chips">
          <label class="chip"><input type="checkbox" value="engineer,developer,software">Engineering</label>
          <label class="chip"><input type="checkbox" value="data,analytics,scientist">Data</label>
          <label class="chip"><input type="checkbox" value="product">Product</label>
          <label class="chip"><input type="checkbox" value="design,ux,ui">Design</label>
          <label class="chip"><input type="checkbox" value="marketing">Marketing</label>
          <label class="chip"><input type="checkbox" value="sales,business,account">Sales</label>
          <label class="chip"><input type="checkbox" value="hr,recruiting,people,talent">HR</label>
          <label class="chip"><input type="checkbox" value="support,customer,success">Support</label>
          <label class="chip"><input type="checkbox" value="operations,ops">Operations</label>
          <label class="chip"><input type="checkbox" value="devops,sre,infrastructure,cloud">DevOps</label>
          <label class="chip"><input type="checkbox" value="security">Security</label>
          <label class="chip"><input type="checkbox" value="ai,ml,machine learning">AI/ML</label>
        </div>
      </div>
    </div>
  </section>

  <!-- ── Job Listings ─────────────────────────────── -->
  <section class="card table-section">
    <div class="card-header">
      <span class="card-title">Job Listings</span>
      <span class="card-badge" id="results-count">—</span>
    </div>
    <div class="jobs-list" id="jobs-list">
      <div class="no-results"><span class="spinner"></span> Loading listings...</div>
    </div>
    <div class="pagination">
      <button id="prev-page" class="btn btn-ghost btn-sm" disabled>&larr; Previous</button>
      <span id="page-info">Page 1</span>
      <button id="next-page" class="btn btn-ghost btn-sm">Next &rarr;</button>
    </div>
  </section>

</div>

<footer>
  <p>JobPulse &mdash; Resilient data pipeline demo &mdash; <a href="https://github.com/AntoineKoerber/JobPulse">View Source &amp; Architecture</a></p>
  <div class="footer-tech">
    <span>Python</span>
    <span>FastAPI</span>
    <span>Supabase</span>
    <span>Chart.js</span>
    <span>Playwright</span>
  </div>
</footer>

<script>
(() => {
  'use strict';

  const SB = 'https://rbwfnhnuvedrljlawisq.supabase.co';
  const KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJid2ZuaG51dmVkcmxqbGF3aXNxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk4MzIwMzgsImV4cCI6MjA4NTQwODAzOH0.wSCGwvtKp-t8FJB6NsCKdwnJJFzHUIldAzMLxgvxL_c';
  const H = { 'apikey': KEY, 'Authorization': `Bearer ${KEY}` };

  const q = (t, p = '') => fetch(`${SB}/rest/v1/${t}?${p}`, { headers: H });

  let page = 1;
  const PAGE_SIZE = 50;
  let salaryChart, historyChart, doughnutChart;

  // ── Decode HTML entities ─────────────────────
  function decodeHtml(s) {
    if (!s) return '';
    const txt = document.createElement('textarea');
    txt.innerHTML = s;
    return txt.value;
  }

  // ── Chip toggle ─────────────────────────────
  document.querySelectorAll('.chip').forEach(chip => {
    chip.addEventListener('click', () => {
      chip.classList.toggle('active');
      chip.querySelector('input').checked = chip.classList.contains('active');
      page = 1;
      loadJobs();
    });
  });

  // ── Enter on filters ──────────────────────────
  document.querySelectorAll('.filter-input').forEach(el => {
    el.addEventListener('keydown', e => { if (e.key === 'Enter') { page = 1; loadJobs(); } });
  });
  document.getElementById('filter-btn').addEventListener('click', () => { page = 1; loadJobs(); });
  document.getElementById('clear-btn').addEventListener('click', () => {
    document.getElementById('filter-role').value = '';
    document.getElementById('filter-location').value = '';
    document.getElementById('filter-salary').value = '';
    document.getElementById('filter-source').value = '';
    document.querySelectorAll('.chip').forEach(c => { c.classList.remove('active'); c.querySelector('input').checked = false; });
    page = 1;
    loadJobs();
  });
  document.getElementById('prev-page').addEventListener('click', () => { if (page > 1) { page--; loadJobs(); } });
  document.getElementById('next-page').addEventListener('click', () => { page++; loadJobs(); });

  // ── Get selected chips ───────────────────────
  function getSelectedChips(containerId) {
    const chips = document.querySelectorAll(`#${containerId} .chip.active input`);
    const values = [];
    chips.forEach(c => values.push(...c.value.split(',')));
    return values;
  }

  // ── Jobs Table ────────────────────────────────
  async function loadJobs() {
    const role = document.getElementById('filter-role').value.trim();
    const loc = document.getElementById('filter-location').value.trim();
    const sal = document.getElementById('filter-salary').value;
    const src = document.getElementById('filter-source').value;
    const seniority = getSelectedChips('seniority-chips');
    const roleTypes = getSelectedChips('role-chips');

    let f = 'is_active=eq.true&order=last_seen.desc';
    if (src) f += `&source=eq.${src}`;
    if (loc) f += `&location=ilike.*${encodeURIComponent(loc)}*`;
    if (role) f += `&or=(title.ilike.*${encodeURIComponent(role)}*,tags.cs.["${role}"])`;
    if (sal) f += `&salary_min=gte.${sal}`;

    // Seniority filter (OR within group)
    if (seniority.length) {
      const seniorityOr = seniority.map(s => `title.ilike.*${s}*`).join(',');
      f += `&or=(${seniorityOr})`;
    }

    // Role type filter (OR within group)
    if (roleTypes.length) {
      const roleOr = roleTypes.map(r => `title.ilike.*${encodeURIComponent(r)}*`).join(',');
      f += `&or=(${roleOr})`;
    }

    const off = (page - 1) * PAGE_SIZE;
    try {
      const res = await fetch(
        `${SB}/rest/v1/job_listings?${f}&select=id,external_id,source,title,company,location,salary_min,salary_max,currency,tags,url`,
        { headers: { ...H, 'Prefer': 'count=exact', 'Range': `${off}-${off + PAGE_SIZE - 1}` } }
      );
      const data = await res.json();
      const total = parseInt(res.headers.get('content-range')?.split('/')[1] || '0');
      renderTable(data);
      updatePag(total, page);
      document.querySelector('#stat-total .stat-value').textContent = total.toLocaleString();
      document.getElementById('hw-total').textContent = total.toLocaleString();
      document.getElementById('results-count').textContent = `${total.toLocaleString()} results`;
    } catch (e) { console.error(e); }
  }

  function renderTable(jobs) {
    const list = document.getElementById('jobs-list');
    if (!jobs.length) {
      list.innerHTML = '<div class="no-results">No listings match your filters</div>';
      return;
    }
    list.innerHTML = jobs.map(j => {
      const sal = fmtSal(j.salary_min, j.salary_max, j.currency);
      const title = esc(titleCase(decodeHtml(j.title)));
      const company = esc(titleCase(decodeHtml(j.company)));
      const loc = esc(titleCase(decodeHtml(j.location) || 'Remote'));
      const hasSalary = j.salary_min || j.salary_max;
      const tags = (j.tags || []).slice(0, 3).map(t => `<span class="tag">${esc(fmtTag(t))}</span>`).join('');
      const url = j.url || '#';

      return `<a href="${url}" target="_blank" rel="noopener" class="job-card">
        <div class="job-main">
          <div class="job-title">${title}</div>
          <div class="job-meta">
            <span class="job-company">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 21h18M9 8h1M9 12h1M9 16h1M14 8h1M14 12h1M14 16h1M5 21V5a2 2 0 012-2h10a2 2 0 012 2v16"/></svg>
              ${company}
            </span>
            <span class="job-location">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/></svg>
              ${loc}
            </span>
          </div>
          ${tags ? `<div class="job-tags">${tags}</div>` : ''}
        </div>
        <div class="job-salary-col">
          <span class="job-salary${hasSalary ? '' : ' none'}">${sal}</span>
          <span class="job-source ${j.source}">${fmtSource(j.source)}</span>
        </div>
        <div class="job-arrow">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
        </div>
      </a>`;
    }).join('');
  }

  function updatePag(total, p) {
    const mx = Math.max(1, Math.ceil(total / PAGE_SIZE));
    document.getElementById('page-info').textContent = `Page ${p} of ${mx}`;
    document.getElementById('prev-page').disabled = p <= 1;
    document.getElementById('next-page').disabled = p >= mx;
  }

  function fmtSal(mn, mx, cur) {
    if (!mn && !mx) return '—';
    const f = n => `${(n / 1000).toFixed(0)}k`;
    const s = cur === 'EUR' ? '\u20ac' : cur === 'GBP' ? '\u00a3' : '$';
    if (mn && mx && mn !== mx) return `${s}${f(mn)} – ${s}${f(mx)}`;
    return `${s}${f(mn || mx)}`;
  }

  function esc(s) { if (!s) return ''; const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

  function titleCase(s) {
    if (!s) return '';
    const minor = new Set(['a','an','the','and','or','but','in','on','at','to','for','of','with','by','from','as']);
    return s.split(' ').map((w, i) => {
      const lo = w.toLowerCase();
      if (i > 0 && minor.has(lo)) return lo;
      if (w === w.toUpperCase() && w.length <= 5) return w; // keep acronyms like "AI", "AWS"
      return lo.charAt(0).toUpperCase() + lo.slice(1);
    }).join(' ');
  }

  function fmtTag(t) {
    if (!t) return '';
    const up = t.trim();
    // Keep short acronyms uppercase
    if (up.length <= 4 && up === up.toUpperCase()) return up;
    return up.charAt(0).toUpperCase() + up.slice(1);
  }

  function fmtSource(s) {
    const map = { remoteok: 'RemoteOK', arbeitnow: 'Arbeitnow', jobicy: 'Jobicy' };
    return map[s] || s;
  }

  // ── Insights ──────────────────────────────────
  async function loadInsights() {
    try {
      const res = await q('job_listings', 'is_active=eq.true&select=tags,salary_min,salary_max,company,source');
      const all = await res.json();

      // Sources breakdown doughnut
      const srcCounts = {};
      all.forEach(l => { srcCounts[l.source] = (srcCounts[l.source] || 0) + 1; });
      renderDoughnut(srcCounts);
      document.querySelector('#stat-sources .stat-value').textContent = Object.keys(srcCounts).length;
      document.getElementById('hw-sources').textContent = `${Object.keys(srcCounts).length} / 3`;

      // Avg quality for hero widget
      const qualRes = await q('job_listings', 'is_active=eq.true&select=quality_score');
      const qualData = await qualRes.json();
      const avgQ = qualData.length ? Math.round(qualData.reduce((s, l) => s + (l.quality_score || 0), 0) / qualData.length) : 0;
      document.getElementById('hw-quality').textContent = `${avgQ} / 100`;

      // Companies
      const compCounts = {};
      all.forEach(l => { compCounts[l.company] = (compCounts[l.company] || 0) + 1; });
      document.querySelector('#stat-companies .stat-value').textContent = Object.keys(compCounts).length.toLocaleString();
      const topComp = Object.entries(compCounts).sort((a, b) => b[1] - a[1]).slice(0, 8);
      renderList('top-companies-list', topComp);

      // Tags — filter out generic/location terms that aren't skills
      const skipTags = new Set(['remote','remote work','worldwide','anywhere','full-time','part-time','contract','freelance','hybrid','onsite','on-site','other','n/a','intern','internship']);
      const tagCounts = {};
      all.forEach(l => (l.tags || []).forEach(t => { const k = t.toLowerCase().trim(); if (!skipTags.has(k) && k.length > 1) tagCounts[k] = (tagCounts[k] || 0) + 1; }));
      const topTags = Object.entries(tagCounts).sort((a, b) => b[1] - a[1]).slice(0, 8);
      renderList('top-tags-list', topTags);

      // Salary
      const bk = { '0–50k': 0, '50–80k': 0, '80–120k': 0, '120–160k': 0, '160–200k': 0, '200k+': 0 };
      all.forEach(l => {
        const s = l.salary_min || l.salary_max;
        if (!s) return;
        if (s < 50000) bk['0–50k']++;
        else if (s < 80000) bk['50–80k']++;
        else if (s < 120000) bk['80–120k']++;
        else if (s < 160000) bk['120–160k']++;
        else if (s < 200000) bk['160–200k']++;
        else bk['200k+']++;
      });
      renderSalary(bk);

      // Scrape history
      const hRes = await q('scrape_runs', 'status=eq.completed&order=started_at.desc&limit=30&select=source,started_at,quality_score,total_count,added_count,removed_count');
      const hist = await hRes.json();
      renderHistory(hist);
      if (hist.length) {
        const d = new Date(hist[0].started_at);
        const formatted = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        document.querySelector('#stat-latest .stat-value').textContent = formatted;
        document.getElementById('hw-refresh').textContent = formatted;
      }
    } catch (e) { console.error(e); }
  }

  function renderList(id, items) {
    const ul = document.getElementById(id);
    const isTags = id.includes('tags');
    ul.innerHTML = items.map(([label, count], i) =>
      `<li><span class="rank">${i + 1}</span><span class="label">${esc(isTags ? fmtTag(label) : titleCase(label))}</span><span class="value">${count}</span></li>`
    ).join('');
  }

  // Chart config
  const gridColor = 'rgba(255,255,255,0.04)';
  const tickColor = '#71717a';
  const baseOpts = {
    responsive: true, maintainAspectRatio: false,
    plugins: { legend: { display: false } },
    scales: {
      x: { ticks: { color: tickColor, font: { size: 11, family: 'Inter' } }, grid: { color: gridColor } },
      y: { ticks: { color: tickColor, font: { size: 11, family: 'Inter' } }, grid: { color: gridColor } },
    },
  };

  function renderDoughnut(srcCounts) {
    const ctx = document.getElementById('sources-doughnut');
    if (doughnutChart) doughnutChart.destroy();
    const labels = Object.keys(srcCounts).map(fmtSource);
    const colors = ['#6366f1', '#22c55e', '#f97316', '#06b6d4', '#a855f7'];
    doughnutChart = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels,
        datasets: [{ data: Object.values(srcCounts), backgroundColor: colors.slice(0, labels.length), borderWidth: 0, hoverOffset: 6 }],
      },
      options: {
        responsive: true, maintainAspectRatio: true, cutout: '65%',
        plugins: {
          legend: { display: true, position: 'bottom', labels: { color: tickColor, font: { size: 12, family: 'Inter' }, padding: 12, usePointStyle: true, pointStyleWidth: 8 } },
        },
      },
    });
  }

  function renderSalary(bk) {
    const ctx = document.getElementById('salary-chart');
    if (salaryChart) salaryChart.destroy();
    const gradient = ctx.getContext('2d').createLinearGradient(0, 0, 0, 250);
    gradient.addColorStop(0, 'rgba(34,197,94,0.5)');
    gradient.addColorStop(1, 'rgba(34,197,94,0.05)');
    salaryChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: Object.keys(bk),
        datasets: [{ data: Object.values(bk), backgroundColor: gradient, borderColor: 'rgba(34,197,94,0.6)', borderWidth: 1, borderRadius: 6 }],
      },
      options: baseOpts,
    });
  }

  function renderHistory(hist) {
    const ctx = document.getElementById('history-chart');
    if (historyChart) historyChart.destroy();
    const sorted = [...hist].reverse();
    historyChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: sorted.map(h => new Date(h.started_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })),
        datasets: [
          { label: 'Added', data: sorted.map(h => h.added_count), borderColor: '#22c55e', backgroundColor: 'rgba(34,197,94,0.08)', fill: true, tension: 0.4, pointRadius: 3, pointBackgroundColor: '#22c55e' },
          { label: 'Removed', data: sorted.map(h => h.removed_count), borderColor: '#ef4444', backgroundColor: 'rgba(239,68,68,0.08)', fill: true, tension: 0.4, pointRadius: 3, pointBackgroundColor: '#ef4444' },
        ],
      },
      options: { ...baseOpts, plugins: { legend: { display: true, labels: { color: tickColor, font: { size: 12, family: 'Inter' }, usePointStyle: true, pointStyleWidth: 8 } } } },
    });
  }

  // ── Init ──────────────────────────────────────
  loadJobs();
  loadInsights();
})();
</script>
</body>
</html>
