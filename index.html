<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>JobPulse — Job Market Intelligence</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --bg-base: #09090b;
      --bg-surface: #111114;
      --bg-card: #18181b;
      --bg-elevated: #1f1f23;
      --bg-hover: #27272a;
      --text-primary: #fafafa;
      --text-secondary: #a1a1aa;
      --text-tertiary: #71717a;
      --border: rgba(255,255,255,0.06);
      --border-subtle: rgba(255,255,255,0.04);
      --accent: #6366f1;
      --accent-glow: rgba(99,102,241,0.15);
      --green: #22c55e;
      --green-glow: rgba(34,197,94,0.12);
      --orange: #f97316;
      --orange-glow: rgba(249,115,22,0.12);
      --red: #ef4444;
      --cyan: #06b6d4;
      --cyan-glow: rgba(6,182,212,0.12);
      --radius: 16px;
      --radius-sm: 10px;
      --shadow: 0 1px 3px rgba(0,0,0,0.4), 0 8px 24px rgba(0,0,0,0.25);
    }

    body {
      background: var(--bg-base);
      color: var(--text-primary);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
    }

    /* ── Hero Header ─────────────────────────────── */
    .hero {
      position: relative;
      overflow: hidden;
      padding: 3.5rem 2rem 3rem;
      background: var(--bg-surface);
      border-bottom: 1px solid var(--border);
    }
    .hero::before {
      content: '';
      position: absolute;
      top: -40%; left: -10%;
      width: 60%; height: 200%;
      background: radial-gradient(ellipse, rgba(99,102,241,0.08) 0%, transparent 70%);
      pointer-events: none;
    }
    .hero::after {
      content: '';
      position: absolute;
      top: -30%; right: -5%;
      width: 40%; height: 180%;
      background: radial-gradient(ellipse, rgba(34,197,94,0.06) 0%, transparent 70%);
      pointer-events: none;
    }
    .hero-inner {
      max-width: 1280px;
      margin: 0 auto;
      position: relative;
      z-index: 1;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 2rem;
    }
    .hero-left { flex: 1; }
    .hero-right {
      flex-shrink: 0;
      width: 280px;
    }
    .hero-widget {
      background: rgba(255,255,255,0.03);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1.5rem;
      backdrop-filter: blur(12px);
    }
    .hero-widget-title {
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-tertiary);
      margin-bottom: 1rem;
    }
    .hero-widget-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.55rem 0;
      border-bottom: 1px solid var(--border-subtle);
    }
    .hero-widget-row:last-child { border-bottom: none; }
    .hero-widget-row .hw-label {
      font-size: 0.82rem;
      color: var(--text-secondary);
    }
    .hero-widget-row .hw-value {
      font-size: 0.85rem;
      font-weight: 700;
      color: var(--text-primary);
    }
    .hw-value.green { color: var(--green); }
    .hw-value.accent { color: #818cf8; }
    .hw-value.orange { color: var(--orange); }
    .hw-value.cyan { color: var(--cyan); }
    @media (max-width: 900px) {
      .hero-inner { flex-direction: column; align-items: flex-start; }
      .hero-right { width: 100%; }
    }
    .hero-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.35rem 0.9rem;
      background: var(--accent-glow);
      border: 1px solid rgba(99,102,241,0.2);
      border-radius: 100px;
      font-size: 0.75rem;
      font-weight: 600;
      color: #a5b4fc;
      margin-bottom: 1rem;
      letter-spacing: 0.02em;
    }
    .hero-badge .pulse {
      width: 6px; height: 6px;
      background: var(--green);
      border-radius: 50%;
      animation: pulse 2s ease-in-out infinite;
    }
    @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.3; } }
    .hero h1 {
      font-size: 2.75rem;
      font-weight: 900;
      letter-spacing: -0.03em;
      line-height: 1.1;
      margin-bottom: 0.5rem;
    }
    .hero h1 .gradient {
      background: linear-gradient(135deg, #818cf8 0%, #6ee7b7 50%, #818cf8 100%);
      background-size: 200% auto;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: shimmer 4s ease-in-out infinite;
    }
    @keyframes shimmer { 0%,100% { background-position: 0% center; } 50% { background-position: 200% center; } }
    .hero-sub {
      font-size: 1.05rem;
      color: var(--text-secondary);
      max-width: 520px;
    }
    .hero-sources {
      display: flex;
      gap: 0.5rem;
      margin-top: 1.25rem;
      flex-wrap: wrap;
    }
    .source-pill {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.3rem 0.75rem;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 100px;
      font-size: 0.78rem;
      font-weight: 500;
      color: var(--text-secondary);
    }
    .source-pill .dot { width: 7px; height: 7px; border-radius: 50%; }
    .source-pill .dot.green { background: var(--green); }
    .source-pill .dot.indigo { background: var(--accent); }

    /* ── Layout ───────────────────────────────────── */
    .container { max-width: 1280px; margin: 0 auto; padding: 1.5rem; }

    /* ── Stat Cards ───────────────────────────────── */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .stat-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1.35rem 1.5rem;
      position: relative;
      overflow: hidden;
      transition: border-color 0.2s, transform 0.2s;
    }
    .stat-card:hover {
      border-color: rgba(255,255,255,0.1);
      transform: translateY(-2px);
    }
    .stat-card .glow {
      position: absolute;
      top: 0; right: 0;
      width: 80px; height: 80px;
      border-radius: 50%;
      filter: blur(35px);
      opacity: 0.5;
      pointer-events: none;
    }
    .stat-card .icon {
      width: 36px; height: 36px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
      margin-bottom: 0.75rem;
    }
    .stat-label {
      display: block;
      font-size: 0.78rem;
      font-weight: 500;
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-bottom: 0.25rem;
    }
    .stat-value {
      font-size: 2rem;
      font-weight: 800;
      letter-spacing: -0.02em;
      line-height: 1.1;
    }
    .stat-card:nth-child(1) .icon { background: var(--accent-glow); }
    .stat-card:nth-child(1) .glow { background: var(--accent); }
    .stat-card:nth-child(1) .stat-value { color: #a5b4fc; }
    .stat-card:nth-child(2) .icon { background: var(--green-glow); }
    .stat-card:nth-child(2) .glow { background: var(--green); }
    .stat-card:nth-child(2) .stat-value { color: #86efac; }
    .stat-card:nth-child(3) .icon { background: var(--orange-glow); }
    .stat-card:nth-child(3) .glow { background: var(--orange); }
    .stat-card:nth-child(3) .stat-value { color: #fdba74; }
    .stat-card:nth-child(4) .icon { background: var(--cyan-glow); }
    .stat-card:nth-child(4) .glow { background: var(--cyan); }
    .stat-card:nth-child(4) .stat-value { color: #67e8f9; }

    /* ── Cards ─────────────────────────────────────── */
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1.5rem;
      box-shadow: var(--shadow);
    }
    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
    }
    .card-title {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text-secondary);
    }
    .card-badge {
      font-size: 0.7rem;
      font-weight: 600;
      padding: 0.2rem 0.6rem;
      background: var(--bg-elevated);
      border-radius: 6px;
      color: var(--text-tertiary);
    }

    /* ── Charts Grid ──────────────────────────────── */
    .charts-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .chart-card { min-height: 300px; }
    .chart-card canvas { max-height: 250px; }

    /* ── Source Breakdown (Doughnut) ───────────────── */
    .insight-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .doughnut-wrap {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .doughnut-wrap canvas { max-width: 200px; max-height: 200px; }
    .insight-list { list-style: none; }
    .insight-list li {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.55rem 0;
      border-bottom: 1px solid var(--border-subtle);
      font-size: 0.85rem;
    }
    .insight-list li:last-child { border-bottom: none; }
    .insight-list .rank {
      width: 1.4rem;
      height: 1.4rem;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-elevated);
      border-radius: 6px;
      font-size: 0.68rem;
      font-weight: 700;
      color: var(--text-tertiary);
      flex-shrink: 0;
    }
    .insight-list li:nth-child(1) .rank { background: rgba(99,102,241,0.15); color: #a5b4fc; }
    .insight-list li:nth-child(2) .rank { background: rgba(34,197,94,0.12); color: #86efac; }
    .insight-list li:nth-child(3) .rank { background: rgba(249,115,22,0.12); color: #fdba74; }
    .insight-list .label { color: var(--text-secondary); flex: 1; margin-left: 0.6rem; }
    .insight-list .value { font-weight: 700; color: var(--text-primary); }

    /* ── Filters ───────────────────────────────────── */
    .filter-section {
      margin-bottom: 1.5rem;
    }

    /* Search bar */
    .search-bar {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      align-items: center;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 0.75rem;
      margin-bottom: 0.75rem;
    }
    .filter-input {
      padding: 0.6rem 0.9rem;
      background: var(--bg-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 0.85rem;
      font-family: inherit;
      transition: border-color 0.2s;
      outline: none;
    }
    .filter-input:focus { border-color: rgba(99,102,241,0.4); background: var(--bg-hover); }
    .filter-input::placeholder { color: var(--text-tertiary); }
    select.filter-input { cursor: pointer; min-width: 120px; }
    option { background: var(--bg-card); color: var(--text-primary); }

    /* Autocomplete */
    .autocomplete-wrap { position: relative; flex: 1; min-width: 140px; }
    .autocomplete-wrap .filter-input { width: 100%; }
    .autocomplete-list {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-top: none;
      border-radius: 0 0 8px 8px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 100;
      display: none;
    }
    .autocomplete-list.show { display: block; }
    .autocomplete-item {
      padding: 0.55rem 0.9rem;
      font-size: 0.82rem;
      color: var(--text-secondary);
      cursor: pointer;
      transition: background 0.1s;
    }
    .autocomplete-item:hover, .autocomplete-item.active {
      background: var(--bg-hover);
      color: var(--text-primary);
    }
    .autocomplete-item mark {
      background: transparent;
      color: var(--accent);
      font-weight: 600;
    }

    /* Filter chips grid */
    .filter-chips-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.75rem;
    }
    .filter-box {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 0.9rem;
    }
    .filter-box-label {
      font-size: 0.68rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.07em;
      color: var(--text-tertiary);
      margin-bottom: 0.6rem;
      display: block;
    }
    .checkbox-group {
      display: flex;
      flex-wrap: wrap;
      gap: 0.35rem;
    }
    .chip {
      display: inline-flex;
      align-items: center;
      padding: 0.3rem 0.6rem;
      background: var(--bg-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: 6px;
      font-size: 0.72rem;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.12s;
      user-select: none;
    }
    .chip:hover { background: var(--bg-hover); color: var(--text-primary); border-color: var(--border); }
    .chip.active { background: var(--accent-glow); border-color: rgba(99,102,241,0.35); color: #a5b4fc; }
    .chip input { display: none; }

    @media (max-width: 800px) {
      .filter-chips-grid { grid-template-columns: 1fr 1fr; }
    }
    @media (max-width: 550px) {
      .filter-chips-grid { grid-template-columns: 1fr; }
      .search-bar { flex-direction: column; }
      .search-bar > *, .autocomplete-wrap { width: 100%; min-width: 0; }
    }

    .btn {
      padding: 0.65rem 1.4rem;
      border: none;
      border-radius: var(--radius-sm);
      font-weight: 600;
      font-size: 0.88rem;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.15s;
    }
    .btn:active { transform: scale(0.97); }
    .btn-accent {
      background: var(--accent);
      color: white;
      box-shadow: 0 2px 8px rgba(99,102,241,0.3);
    }
    .btn-accent:hover { background: #818cf8; }
    .btn-ghost {
      background: var(--bg-elevated);
      color: var(--text-secondary);
      border: 1px solid var(--border);
    }
    .btn-ghost:hover { background: var(--bg-hover); color: var(--text-primary); }
    .btn-sm { padding: 0.4rem 1rem; font-size: 0.8rem; border-radius: 8px; }
    .btn-sm:disabled { opacity: 0.35; cursor: default; pointer-events: none; }

    /* ── Job Listings ─────────────────────────────────── */
    .table-section { margin-bottom: 1.5rem; }
    .jobs-list { display: flex; flex-direction: column; gap: 0.4rem; }

    .job-card {
      display: grid;
      grid-template-columns: 28px minmax(200px, 2fr) minmax(120px, 1fr) minmax(100px, 1fr) minmax(100px, 140px) 80px 36px;
      gap: 1rem;
      align-items: center;
      padding: 0.9rem 1.25rem;
      background: var(--bg-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 0.15s ease;
      text-decoration: none;
    }
    .job-card:hover {
      background: var(--bg-hover);
      border-color: var(--border);
    }
    .job-card:hover .job-arrow { opacity: 1; color: var(--accent); }

    .job-main { display: flex; flex-direction: column; gap: 0.2rem; min-width: 0; }
    .job-title {
      font-size: 0.88rem;
      font-weight: 600;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .job-company {
      display: flex;
      align-items: center;
      gap: 0.3rem;
      font-size: 0.78rem;
      color: var(--text-secondary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .job-company svg { width: 12px; height: 12px; opacity: 0.5; flex-shrink: 0; }

    .job-location {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      font-size: 0.8rem;
      color: var(--text-secondary);
      min-width: 0;
    }
    .job-location-text {
      display: flex;
      align-items: center;
      gap: 0.3rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .job-location svg { width: 13px; height: 13px; opacity: 0.5; flex-shrink: 0; }

    .work-type {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.18rem 0.45rem;
      border-radius: 4px;
      font-size: 0.65rem;
      font-weight: 600;
      width: fit-content;
    }
    .work-type.remote {
      background: rgba(34, 197, 94, 0.12);
      color: #4ade80;
    }
    .work-type.hybrid {
      background: rgba(251, 191, 36, 0.12);
      color: #fbbf24;
    }
    .work-type.onsite {
      background: rgba(99, 102, 241, 0.1);
      color: #a5b4fc;
    }
    .work-type svg { width: 10px; height: 10px; }

    .job-tags { display: flex; gap: 0.25rem; flex-wrap: wrap; }

    .job-salary {
      font-size: 0.85rem;
      font-weight: 700;
      color: var(--green);
      white-space: nowrap;
      text-align: right;
    }
    .job-salary.none {
      font-size: 0.78rem;
      font-weight: 400;
      color: var(--text-tertiary);
    }

    .job-source {
      padding: 0.25rem 0.6rem;
      border-radius: 4px;
      font-size: 0.68rem;
      font-weight: 600;
      letter-spacing: 0.02em;
      text-align: center;
      white-space: nowrap;
    }
    .job-source.remoteok { background: var(--green-glow); color: var(--green); }
    .job-source.arbeitnow { background: var(--accent-glow); color: #a5b4fc; }
    .job-source.jobicy { background: var(--orange-glow); color: var(--orange); }

    .job-arrow {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      color: var(--text-tertiary);
      opacity: 0.3;
      transition: all 0.15s;
    }
    .job-arrow svg { width: 16px; height: 16px; }

    .tag {
      display: inline-block;
      padding: 0.15rem 0.45rem;
      background: rgba(99,102,241,0.08);
      color: #a5b4fc;
      border-radius: 4px;
      font-size: 0.65rem;
      font-weight: 500;
    }

    .no-results {
      text-align: center;
      padding: 3rem 1rem;
      color: var(--text-tertiary);
      font-size: 0.9rem;
    }

    /* Header row for job listings */
    .jobs-header {
      display: grid;
      grid-template-columns: 28px minmax(200px, 2fr) minmax(120px, 1fr) minmax(100px, 1fr) minmax(100px, 140px) 80px 36px;
      gap: 1rem;
      padding: 0.6rem 1.25rem;
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      border-bottom: 1px solid var(--border-subtle);
      margin-bottom: 0.25rem;
    }
    .jobs-header span:nth-child(5),
    .jobs-header span:nth-child(6) { text-align: right; }

    .col-filter {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      cursor: pointer;
      padding: 0.2rem 0.4rem;
      margin: -0.2rem -0.4rem;
      border-radius: 4px;
      transition: all 0.15s;
      user-select: none;
    }
    .col-filter:hover { background: var(--bg-hover); color: var(--text-secondary); }
    .col-filter.active { background: var(--accent-glow); color: #a5b4fc; }
    .col-filter svg { width: 12px; height: 12px; opacity: 0.6; }
    .col-filter.active svg { opacity: 1; }

    @media (max-width: 900px) {
      .job-card { grid-template-columns: 28px 1fr auto auto; }
      .job-location, .job-tags, .jobs-header { display: none; }
    }
    @media (max-width: 600px) {
      .job-card { grid-template-columns: 28px 1fr auto; padding: 0.85rem 1rem; }
      .job-source, .job-arrow { display: none; }
    }

    .pagination {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1rem;
      padding: 1.25rem 0 0.5rem;
    }
    #page-info { font-size: 0.82rem; color: var(--text-tertiary); font-weight: 500; }

    /* ── Footer ────────────────────────────────────── */
    footer {
      text-align: center;
      padding: 2.5rem 2rem;
      color: var(--text-tertiary);
      font-size: 0.8rem;
      border-top: 1px solid var(--border);
      margin-top: 1rem;
    }
    footer a { color: #a5b4fc; text-decoration: none; }
    footer a:hover { text-decoration: underline; }
    .footer-tech {
      display: flex;
      justify-content: center;
      gap: 1.5rem;
      margin-top: 0.6rem;
      flex-wrap: wrap;
    }
    .footer-tech span { font-weight: 500; }

    /* ── Loading ────────────────────────────────────── */
    .loading-cell {
      text-align: center;
      padding: 3rem;
      color: var(--text-tertiary);
    }
    .spinner {
      display: inline-block;
      width: 20px; height: 20px;
      border: 2px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
      margin-right: 0.5rem;
      vertical-align: middle;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ── Animate in ────────────────────────────────── */
    .fade-in {
      opacity: 0;
      transform: translateY(12px);
      animation: fadeIn 0.5s ease forwards;
    }
    @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }
    .fade-in:nth-child(1) { animation-delay: 0s; }
    .fade-in:nth-child(2) { animation-delay: 0.06s; }
    .fade-in:nth-child(3) { animation-delay: 0.12s; }
    .fade-in:nth-child(4) { animation-delay: 0.18s; }

    /* ── Listing Tabs ─────────────────────────────── */
    .listing-tabs {
      display: flex;
      gap: 0;
    }
    .listing-tab {
      padding: 0.4rem 1rem;
      background: none;
      border: none;
      font-family: inherit;
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text-tertiary);
      cursor: pointer;
      position: relative;
      transition: color 0.2s;
    }
    .listing-tab:hover { color: var(--text-secondary); }
    .listing-tab.active {
      color: var(--accent);
    }
    .listing-tab.active::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0.5rem;
      right: 0.5rem;
      height: 2px;
      background: var(--accent);
      border-radius: 1px;
    }
    .listing-tab .saved-count {
      font-size: 0.75rem;
      color: inherit;
      opacity: 0.7;
    }

    /* ── Bookmark Button ─────────────────────────── */
    .bookmark-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      background: none;
      border: none;
      cursor: pointer;
      color: var(--text-tertiary);
      opacity: 0.4;
      transition: all 0.15s;
      padding: 0;
      flex-shrink: 0;
    }
    .bookmark-btn:hover { opacity: 0.8; color: var(--accent); }
    .bookmark-btn.saved { opacity: 1; color: var(--accent); }
    .bookmark-btn.saved svg { fill: var(--accent); }
    .bookmark-btn svg { width: 16px; height: 16px; }
    @keyframes bookmark-pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.3); }
      100% { transform: scale(1); }
    }
    .bookmark-btn.pulse-anim {
      animation: bookmark-pulse 0.3s ease;
    }

    /* ── Responsive ────────────────────────────────── */
    @media (max-width: 900px) {
      .stats-grid { grid-template-columns: repeat(2, 1fr); }
      .charts-grid { grid-template-columns: 1fr; }
      .insight-grid { grid-template-columns: 1fr; }
      .hero h1 { font-size: 2rem; }
    }
    @media (max-width: 560px) {
      .stats-grid { grid-template-columns: 1fr; }
      .filters { flex-direction: column; }
      .hero h1 { font-size: 1.6rem; }
    }
  </style>
</head>
<body>

<!-- ── Hero ──────────────────────────────────────── -->
<section class="hero">
  <div class="hero-inner">
    <div class="hero-left">
      <div class="hero-badge"><span class="pulse"></span> Live Data</div>
      <h1>Job Market<br><span class="gradient">Intelligence</span></h1>
      <p class="hero-sub">Aggregated job listings from multiple sources with real-time analytics, trend detection, and salary insights.</p>
      <div class="hero-sources">
        <span class="source-pill"><span class="dot green"></span> RemoteOK</span>
        <span class="source-pill"><span class="dot indigo"></span> Arbeitnow</span>
        <span class="source-pill"><span class="dot" style="background:var(--orange)"></span> Jobicy</span>
        <span class="source-pill">Supabase PostgreSQL</span>
        <span class="source-pill">FastAPI Pipeline</span>
      </div>
    </div>
    <div class="hero-right">
      <div class="hero-widget">
        <div class="hero-widget-title">Pipeline Status</div>
        <div class="hero-widget-row"><span class="hw-label">Total Listings</span><span class="hw-value green" id="hw-total">—</span></div>
        <div class="hero-widget-row"><span class="hw-label">Sources Active</span><span class="hw-value accent" id="hw-sources">—</span></div>
        <div class="hero-widget-row"><span class="hw-label">Avg Quality</span><span class="hw-value cyan" id="hw-quality">—</span></div>
        <div class="hero-widget-row"><span class="hw-label">Last Refresh</span><span class="hw-value orange" id="hw-refresh">—</span></div>
      </div>
    </div>
  </div>
</section>

<div class="container">

  <!-- ── Stats ────────────────────────────────────── -->
  <section class="stats-grid">
    <div class="stat-card fade-in" id="stat-total">
      <div class="glow"></div>
      <div class="icon">&#128202;</div>
      <span class="stat-label">Active Listings</span>
      <span class="stat-value">—</span>
    </div>
    <div class="stat-card fade-in" id="stat-sources">
      <div class="glow"></div>
      <div class="icon">&#127760;</div>
      <span class="stat-label">Data Sources</span>
      <span class="stat-value">—</span>
    </div>
    <div class="stat-card fade-in" id="stat-companies">
      <div class="glow"></div>
      <div class="icon">&#127970;</div>
      <span class="stat-label">Companies</span>
      <span class="stat-value">—</span>
    </div>
    <div class="stat-card fade-in" id="stat-latest">
      <div class="glow"></div>
      <div class="icon">&#128337;</div>
      <span class="stat-label">Last Scrape</span>
      <span class="stat-value">—</span>
    </div>
  </section>

  <!-- ── Insight Row: Sources Doughnut + Top Tags + Top Companies ── -->
  <section class="insight-grid">
    <div class="card fade-in">
      <div class="card-header">
        <span class="card-title">Sources Breakdown</span>
        <span class="card-badge">Live</span>
      </div>
      <div class="doughnut-wrap">
        <canvas id="sources-doughnut"></canvas>
      </div>
    </div>
    <div class="card fade-in">
      <div class="card-header">
        <span class="card-title">Top Skills</span>
        <span class="card-badge">By frequency</span>
      </div>
      <ul class="insight-list" id="top-tags-list"></ul>
    </div>
    <div class="card fade-in">
      <div class="card-header">
        <span class="card-title">Top Companies</span>
        <span class="card-badge">Most listings</span>
      </div>
      <ul class="insight-list" id="top-companies-list"></ul>
    </div>
  </section>

  <!-- ── Charts ───────────────────────────────────── -->
  <section class="charts-grid">
    <div class="card chart-card fade-in">
      <div class="card-header">
        <span class="card-title">Salary Distribution</span>
        <span class="card-badge">USD equivalent</span>
      </div>
      <canvas id="salary-chart"></canvas>
    </div>
    <div class="card chart-card fade-in">
      <div class="card-header">
        <span class="card-title">Scrape History</span>
        <span class="card-badge">Added vs Removed</span>
      </div>
      <canvas id="history-chart"></canvas>
    </div>
  </section>

  <!-- ── Filters ──────────────────────────────────── -->
  <section class="filter-section">
    <!-- Search Bar -->
    <div class="search-bar">
      <div class="autocomplete-wrap">
        <input class="filter-input" type="text" id="filter-role" placeholder="Job title or keyword..." autocomplete="off" />
        <div class="autocomplete-list" id="role-suggestions"></div>
      </div>
      <div class="autocomplete-wrap">
        <input class="filter-input" type="text" id="filter-location" placeholder="City or country..." autocomplete="off" />
        <div class="autocomplete-list" id="location-suggestions"></div>
      </div>
      <input class="filter-input" type="number" id="filter-salary" placeholder="Min salary..." style="max-width:130px" />
      <select class="filter-input" id="filter-source">
        <option value="">All Sources</option>
        <option value="remoteok">RemoteOK</option>
        <option value="arbeitnow">Arbeitnow</option>
        <option value="jobicy">Jobicy</option>
      </select>
      <button id="filter-btn" class="btn btn-accent">Search</button>
      <button id="clear-btn" class="btn btn-ghost">Clear</button>
    </div>

    <!-- Filter Chips -->
    <div class="filter-chips-grid">
      <div class="filter-box">
        <span class="filter-box-label">Seniority Level</span>
        <div class="checkbox-group" id="seniority-chips">
          <label class="chip"><input type="checkbox" value="senior">Senior</label>
          <label class="chip"><input type="checkbox" value="mid">Mid-Level</label>
          <label class="chip"><input type="checkbox" value="junior">Junior</label>
          <label class="chip"><input type="checkbox" value="lead">Lead</label>
          <label class="chip"><input type="checkbox" value="manager">Manager</label>
          <label class="chip"><input type="checkbox" value="director">Director</label>
          <label class="chip"><input type="checkbox" value="staff">Staff</label>
          <label class="chip"><input type="checkbox" value="principal">Principal</label>
        </div>
      </div>

      <div class="filter-box">
        <span class="filter-box-label">Role Category</span>
        <div class="checkbox-group" id="role-chips">
          <label class="chip"><input type="checkbox" value="engineer,developer,software">Engineering</label>
          <label class="chip"><input type="checkbox" value="data,analytics,scientist">Data</label>
          <label class="chip"><input type="checkbox" value="product">Product</label>
          <label class="chip"><input type="checkbox" value="design,ux,ui">Design</label>
          <label class="chip"><input type="checkbox" value="marketing">Marketing</label>
          <label class="chip"><input type="checkbox" value="sales,business,account">Sales</label>
          <label class="chip"><input type="checkbox" value="hr,recruiting,people,talent">HR</label>
          <label class="chip"><input type="checkbox" value="support,customer,success">Support</label>
          <label class="chip"><input type="checkbox" value="operations,ops">Ops</label>
          <label class="chip"><input type="checkbox" value="devops,sre,infrastructure,cloud">DevOps</label>
          <label class="chip"><input type="checkbox" value="security">Security</label>
          <label class="chip"><input type="checkbox" value="ai,ml,machine learning">AI/ML</label>
        </div>
      </div>

      <div class="filter-box">
        <span class="filter-box-label">Work Arrangement</span>
        <div class="checkbox-group" id="worktype-chips">
          <label class="chip"><input type="checkbox" value="remote">Remote</label>
          <label class="chip"><input type="checkbox" value="hybrid">Hybrid</label>
          <label class="chip"><input type="checkbox" value="onsite">On-site</label>
        </div>
      </div>
    </div>
  </section>

  <!-- ── Job Listings ─────────────────────────────── -->
  <section class="card table-section">
    <div class="card-header">
      <div class="listing-tabs">
        <button class="listing-tab active" id="tab-all">All Jobs</button>
        <button class="listing-tab" id="tab-saved">Saved <span class="saved-count">(0)</span></button>
      </div>
      <span class="card-badge" id="results-count">—</span>
    </div>
    <div class="jobs-header">
      <span></span>
      <span>Position</span>
      <span>Location</span>
      <span>Skills</span>
      <span>
        <span class="col-filter" id="salary-filter" title="Click to filter by salary">
          Salary
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 4h13M3 8h9m-9 4h6m4 0l4 4m0 0l4-4m-4 4V4"/></svg>
        </span>
      </span>
      <span>Source</span>
      <span></span>
    </div>
    <div class="jobs-list" id="jobs-list">
      <div class="no-results"><span class="spinner"></span> Loading listings...</div>
    </div>
    <div class="pagination">
      <button id="prev-page" class="btn btn-ghost btn-sm" disabled>&larr; Previous</button>
      <span id="page-info">Page 1</span>
      <button id="next-page" class="btn btn-ghost btn-sm">Next &rarr;</button>
    </div>
  </section>

</div>

<footer>
  <p>JobPulse &mdash; Resilient data pipeline demo &mdash; <a href="https://github.com/AntoineKoerber/JobPulse">View Source &amp; Architecture</a></p>
  <div class="footer-tech">
    <span>Python</span>
    <span>FastAPI</span>
    <span>Supabase</span>
    <span>Chart.js</span>
    <span>Playwright</span>
  </div>
</footer>

<script>
(() => {
  'use strict';

  const SB = 'https://rbwfnhnuvedrljlawisq.supabase.co';
  const KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJid2ZuaG51dmVkcmxqbGF3aXNxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk4MzIwMzgsImV4cCI6MjA4NTQwODAzOH0.wSCGwvtKp-t8FJB6NsCKdwnJJFzHUIldAzMLxgvxL_c';
  const H = { 'apikey': KEY, 'Authorization': `Bearer ${KEY}` };

  const q = (t, p = '') => fetch(`${SB}/rest/v1/${t}?${p}`, { headers: H });

  // ── Supabase Client ─────────────────────────────
  const supabase = window.supabase.createClient(SB, KEY);
  let currentUserId = null;

  let page = 1;
  const PAGE_SIZE = 50;
  let salaryChart, historyChart, doughnutChart;
  let allLocations = [];
  let allRoles = [];
  let salaryFilter = 'all'; // 'all', 'has', 'none'
  let viewMode = 'all'; // 'all' | 'saved'

  // ── Saved / Bookmark helpers (Supabase) ─────────
  let savedIds = new Set();

  async function initAuth() {
    // Check for existing session
    const { data: { session } } = await supabase.auth.getSession();
    if (session?.user) {
      currentUserId = session.user.id;
    } else {
      // Create anonymous session
      const { data, error } = await supabase.auth.signInAnonymously();
      if (error) {
        console.error('Anonymous auth failed:', error);
        return;
      }
      currentUserId = data.user.id;
    }
    await loadSavedIds();
  }

  async function loadSavedIds() {
    if (!currentUserId) return;
    const { data, error } = await supabase
      .from('saved_jobs')
      .select('job_id')
      .eq('user_id', currentUserId);
    if (error) {
      console.error('Failed to load saved jobs:', error);
      return;
    }
    savedIds = new Set(data.map(r => r.job_id));
    updateSavedCount();
  }

  function isSaved(id) { return savedIds.has(id); }

  async function toggleSaved(id) {
    if (!currentUserId) return;
    if (savedIds.has(id)) {
      // Remove from saved
      const { error } = await supabase
        .from('saved_jobs')
        .delete()
        .eq('user_id', currentUserId)
        .eq('job_id', id);
      if (!error) savedIds.delete(id);
    } else {
      // Add to saved
      const { error } = await supabase
        .from('saved_jobs')
        .insert({ user_id: currentUserId, job_id: id });
      if (!error) savedIds.add(id);
    }
    updateSavedCount();
  }

  function updateSavedCount() {
    const el = document.querySelector('#tab-saved .saved-count');
    if (el) el.textContent = `(${savedIds.size})`;
  }

  // ── Decode HTML entities ─────────────────────
  function decodeHtml(s) {
    if (!s) return '';
    const txt = document.createElement('textarea');
    txt.innerHTML = s;
    return txt.value;
  }

  // ── Autocomplete ─────────────────────────────
  async function loadSuggestions() {
    try {
      const res = await q('job_listings', 'is_active=eq.true&select=location,title');
      const data = await res.json();

      // Unique locations
      const locSet = new Set();
      data.forEach(d => { if (d.location && d.location.length > 1) locSet.add(d.location); });
      allLocations = [...locSet].sort();

      // Common role keywords from titles
      const roleWords = {};
      const rolePatterns = ['engineer', 'developer', 'manager', 'designer', 'analyst', 'director', 'lead', 'senior', 'junior', 'architect', 'consultant', 'specialist', 'coordinator', 'associate', 'assistant', 'intern', 'head', 'vp', 'chief', 'officer', 'admin', 'support', 'sales', 'marketing', 'product', 'project', 'data', 'software', 'frontend', 'backend', 'fullstack', 'devops', 'cloud', 'security', 'qa', 'test', 'mobile', 'ios', 'android', 'web', 'ui', 'ux', 'hr', 'finance', 'operations', 'customer', 'success', 'account', 'business', 'content', 'writer', 'editor'];
      data.forEach(d => {
        const words = (d.title || '').toLowerCase().split(/\s+/);
        words.forEach(w => {
          if (rolePatterns.some(p => w.includes(p)) && w.length > 2) {
            roleWords[w] = (roleWords[w] || 0) + 1;
          }
        });
      });
      allRoles = Object.entries(roleWords).filter(([k, v]) => v >= 3).sort((a, b) => b[1] - a[1]).map(([k]) => k);
    } catch (e) { console.error('Failed to load suggestions', e); }
  }

  function setupAutocomplete(inputId, listId, getSuggestions) {
    const input = document.getElementById(inputId);
    const list = document.getElementById(listId);
    let activeIdx = -1;

    input.addEventListener('input', () => {
      const val = input.value.toLowerCase().trim();
      if (val.length < 1) { list.classList.remove('show'); return; }

      const matches = getSuggestions().filter(s => s.toLowerCase().includes(val)).slice(0, 8);
      if (!matches.length) { list.classList.remove('show'); return; }

      list.innerHTML = matches.map(m => {
        const idx = m.toLowerCase().indexOf(val);
        const highlighted = m.slice(0, idx) + '<mark>' + m.slice(idx, idx + val.length) + '</mark>' + m.slice(idx + val.length);
        return `<div class="autocomplete-item">${highlighted}</div>`;
      }).join('');
      list.classList.add('show');
      activeIdx = -1;

      list.querySelectorAll('.autocomplete-item').forEach((item, i) => {
        item.addEventListener('click', () => {
          input.value = matches[i];
          list.classList.remove('show');
          page = 1;
          loadJobs();
        });
      });
    });

    input.addEventListener('keydown', e => {
      const items = list.querySelectorAll('.autocomplete-item');
      if (!list.classList.contains('show') || !items.length) return;

      if (e.key === 'ArrowDown') {
        e.preventDefault();
        activeIdx = Math.min(activeIdx + 1, items.length - 1);
        items.forEach((it, i) => it.classList.toggle('active', i === activeIdx));
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        activeIdx = Math.max(activeIdx - 1, 0);
        items.forEach((it, i) => it.classList.toggle('active', i === activeIdx));
      } else if (e.key === 'Enter' && activeIdx >= 0) {
        e.preventDefault();
        input.value = items[activeIdx].textContent;
        list.classList.remove('show');
        page = 1;
        loadJobs();
      } else if (e.key === 'Escape') {
        list.classList.remove('show');
      }
    });

    input.addEventListener('blur', () => { setTimeout(() => list.classList.remove('show'), 150); });
  }

  // ── Chip toggle ─────────────────────────────
  document.querySelectorAll('.chip').forEach(chip => {
    chip.addEventListener('click', () => {
      chip.classList.toggle('active');
      chip.querySelector('input').checked = chip.classList.contains('active');
      page = 1;
      loadJobs();
    });
  });

  // ── Enter on filters ──────────────────────────
  document.querySelectorAll('.filter-input').forEach(el => {
    el.addEventListener('keydown', e => { if (e.key === 'Enter') { page = 1; loadJobs(); } });
  });
  document.getElementById('filter-btn').addEventListener('click', () => { page = 1; loadJobs(); });
  document.getElementById('clear-btn').addEventListener('click', () => {
    document.getElementById('filter-role').value = '';
    document.getElementById('filter-location').value = '';
    document.getElementById('filter-salary').value = '';
    document.getElementById('filter-source').value = '';
    document.querySelectorAll('.chip').forEach(c => { c.classList.remove('active'); c.querySelector('input').checked = false; });
    salaryFilter = 'all';
    document.getElementById('salary-filter').classList.remove('active');
    document.getElementById('salary-filter').title = 'Click to show only jobs with salary';
    page = 1;
    loadJobs();
  });

  // ── Tab click handlers ──────────────────────
  document.getElementById('tab-all').addEventListener('click', () => {
    viewMode = 'all';
    document.getElementById('tab-all').classList.add('active');
    document.getElementById('tab-saved').classList.remove('active');
    page = 1;
    loadJobs();
  });
  document.getElementById('tab-saved').addEventListener('click', () => {
    viewMode = 'saved';
    document.getElementById('tab-saved').classList.add('active');
    document.getElementById('tab-all').classList.remove('active');
    page = 1;
    loadJobs();
  });

  // ── Bookmark click delegation ─────────────────
  document.getElementById('jobs-list').addEventListener('click', async (e) => {
    const btn = e.target.closest('.bookmark-btn');
    if (!btn) return;
    e.preventDefault();
    e.stopPropagation();
    const id = Number(btn.dataset.id);
    const wasSaved = isSaved(id);
    // Optimistic UI update
    btn.classList.toggle('saved');
    btn.title = wasSaved ? 'Save this job' : 'Remove from saved';
    // Pulse animation
    btn.classList.remove('pulse-anim');
    void btn.offsetWidth; // reflow to restart animation
    btn.classList.add('pulse-anim');
    // Persist to Supabase
    await toggleSaved(id);
    // If in saved view and we just unsaved, reload to remove from list
    if (viewMode === 'saved' && wasSaved) {
      loadJobs();
    }
  });

  // Salary column filter (cycles: all -> has -> none -> all)
  document.getElementById('salary-filter').addEventListener('click', () => {
    const el = document.getElementById('salary-filter');
    if (salaryFilter === 'all') {
      salaryFilter = 'has';
      el.classList.add('active');
      el.innerHTML = 'With Salary <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg>';
      el.title = 'Showing jobs with salary. Click to show jobs without salary.';
    } else if (salaryFilter === 'has') {
      salaryFilter = 'none';
      el.innerHTML = 'No Salary <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>';
      el.title = 'Showing jobs without salary. Click to show all jobs.';
    } else {
      salaryFilter = 'all';
      el.classList.remove('active');
      el.innerHTML = 'Salary <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 4h13M3 8h9m-9 4h6m4 0l4 4m0 0l4-4m-4 4V4"/></svg>';
      el.title = 'Click to show only jobs with salary';
    }
    page = 1;
    loadJobs();
  });
  document.getElementById('prev-page').addEventListener('click', () => { if (page > 1) { page--; loadJobs(); } });
  document.getElementById('next-page').addEventListener('click', () => { page++; loadJobs(); });

  // ── Get selected chips ───────────────────────
  function getSelectedChips(containerId) {
    const chips = document.querySelectorAll(`#${containerId} .chip.active input`);
    const values = [];
    chips.forEach(c => values.push(...c.value.split(',')));
    return values;
  }

  // ── Jobs Table ────────────────────────────────
  async function loadJobs() {
    const role = document.getElementById('filter-role').value.trim();
    const loc = document.getElementById('filter-location').value.trim();
    const sal = document.getElementById('filter-salary').value;
    const src = document.getElementById('filter-source').value;
    const seniority = getSelectedChips('seniority-chips');
    const roleTypes = getSelectedChips('role-chips');
    const workTypes = getSelectedChips('worktype-chips');

    // Saved view: short-circuit if nothing saved
    if (viewMode === 'saved' && savedIds.size === 0) {
      document.getElementById('jobs-list').innerHTML = '<div class="no-results">No saved jobs yet — click the bookmark icon to save listings</div>';
      updatePag(0, 1);
      document.getElementById('results-count').textContent = '0 results';
      return;
    }

    let f = 'is_active=eq.true&order=last_seen.desc';
    if (viewMode === 'saved') {
      f += `&id=in.(${[...savedIds].join(',')})`;
    }
    if (src) f += `&source=eq.${src}`;
    if (loc) f += `&location=ilike.*${encodeURIComponent(loc)}*`;
    if (role) f += `&or=(title.ilike.*${encodeURIComponent(role)}*,tags.cs.["${role}"])`;
    if (sal) f += `&salary_min=gte.${sal}`;

    // Seniority filter (OR within group)
    if (seniority.length) {
      const seniorityOr = seniority.map(s => `title.ilike.*${s}*`).join(',');
      f += `&or=(${seniorityOr})`;
    }

    // Role type filter (OR within group)
    if (roleTypes.length) {
      const roleOr = roleTypes.map(r => `title.ilike.*${encodeURIComponent(r)}*`).join(',');
      f += `&or=(${roleOr})`;
    }

    // Work type filter
    if (workTypes.length === 1) {
      if (workTypes[0] === 'remote') {
        f += '&or=(source.in.(remoteok,jobicy),location.ilike.*remote*)';
      } else if (workTypes[0] === 'hybrid') {
        f += '&location=ilike.*hybrid*';
      } else if (workTypes[0] === 'onsite') {
        f += '&source=eq.arbeitnow&not.location=ilike.*remote*';
      }
    } else if (workTypes.length > 1) {
      // Multiple work types - build OR conditions
      const wtConds = [];
      if (workTypes.includes('remote')) wtConds.push('source.in.(remoteok,jobicy)', 'location.ilike.*remote*');
      if (workTypes.includes('hybrid')) wtConds.push('location.ilike.*hybrid*');
      if (workTypes.includes('onsite')) wtConds.push('and(source.eq.arbeitnow,not.location.ilike.*remote*)');
      if (wtConds.length) f += `&or=(${wtConds.join(',')})`;
    }

    // Salary info filter (from column header)
    if (salaryFilter === 'has') {
      f += '&or=(salary_min.not.is.null,salary_max.not.is.null)';
    } else if (salaryFilter === 'none') {
      f += '&salary_min=is.null&salary_max=is.null';
    }

    const off = (page - 1) * PAGE_SIZE;
    try {
      const res = await fetch(
        `${SB}/rest/v1/job_listings?${f}&select=id,external_id,source,title,company,location,salary_min,salary_max,currency,tags,url`,
        { headers: { ...H, 'Prefer': 'count=exact', 'Range': `${off}-${off + PAGE_SIZE - 1}` } }
      );
      const data = await res.json();
      const total = parseInt(res.headers.get('content-range')?.split('/')[1] || '0');
      renderTable(data);
      updatePag(total, page);
      if (viewMode === 'all') {
        document.querySelector('#stat-total .stat-value').textContent = total.toLocaleString();
        document.getElementById('hw-total').textContent = total.toLocaleString();
      }
      document.getElementById('results-count').textContent = `${total.toLocaleString()} results`;
    } catch (e) { console.error(e); }
  }

  function renderTable(jobs) {
    const list = document.getElementById('jobs-list');
    if (!jobs.length) {
      list.innerHTML = '<div class="no-results">No listings match your filters</div>';
      return;
    }
    list.innerHTML = jobs.map(j => {
      const sal = fmtSal(j.salary_min, j.salary_max, j.currency);
      const title = esc(titleCase(decodeHtml(j.title)));
      const company = esc(titleCase(decodeHtml(j.company)));
      const rawLoc = decodeHtml(j.location) || '';
      const loc = esc(titleCase(rawLoc) || '—');
      const hasSalary = j.salary_min || j.salary_max;
      const tags = (j.tags || []).slice(0, 2).map(t => `<span class="tag">${esc(fmtTag(t))}</span>`).join('');
      const url = j.url || '#';
      const workType = getWorkType(rawLoc, j.source, j.tags);

      const saved = isSaved(j.id);
      return `<a href="${url}" target="_blank" rel="noopener" class="job-card">
        <button class="bookmark-btn${saved ? ' saved' : ''}" data-id="${j.id}" title="${saved ? 'Remove from saved' : 'Save this job'}">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21l-7-5-7 5V5a2 2 0 012-2h10a2 2 0 012 2z"/></svg>
        </button>
        <div class="job-main">
          <div class="job-title">${title}</div>
          <span class="job-company">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 21h18M9 8h1M9 12h1M9 16h1M14 8h1M14 12h1M14 16h1M5 21V5a2 2 0 012-2h10a2 2 0 012 2v16"/></svg>
            ${company}
          </span>
        </div>
        <div class="job-location">
          <span class="job-location-text">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/></svg>
            ${loc}
          </span>
          ${workTypeBadge(workType)}
        </div>
        <div class="job-tags">${tags || '<span class="tag" style="opacity:0.3">—</span>'}</div>
        <span class="job-salary${hasSalary ? '' : ' none'}">${sal}</span>
        <span class="job-source ${j.source}">${fmtSource(j.source)}</span>
        <div class="job-arrow">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
        </div>
      </a>`;
    }).join('');
  }

  function updatePag(total, p) {
    const mx = Math.max(1, Math.ceil(total / PAGE_SIZE));
    document.getElementById('page-info').textContent = `Page ${p} of ${mx}`;
    document.getElementById('prev-page').disabled = p <= 1;
    document.getElementById('next-page').disabled = p >= mx;
  }

  function fmtSal(mn, mx, cur) {
    if (!mn && !mx) return '—';
    const f = n => `${(n / 1000).toFixed(0)}k`;
    const s = cur === 'EUR' ? '\u20ac' : cur === 'GBP' ? '\u00a3' : '$';
    if (mn && mx && mn !== mx) return `${s}${f(mn)} – ${s}${f(mx)}`;
    return `${s}${f(mn || mx)}`;
  }

  function esc(s) { if (!s) return ''; const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

  function titleCase(s) {
    if (!s) return '';
    const minor = new Set(['a','an','the','and','or','but','in','on','at','to','for','of','with','by','from','as']);
    return s.split(' ').map((w, i) => {
      const lo = w.toLowerCase();
      if (i > 0 && minor.has(lo)) return lo;
      if (w === w.toUpperCase() && w.length <= 5) return w; // keep acronyms like "AI", "AWS"
      return lo.charAt(0).toUpperCase() + lo.slice(1);
    }).join(' ');
  }

  function fmtTag(t) {
    if (!t) return '';
    const up = t.trim();
    // Keep short acronyms uppercase
    if (up.length <= 4 && up === up.toUpperCase()) return up;
    return up.charAt(0).toUpperCase() + up.slice(1);
  }

  function fmtSource(s) {
    const map = { remoteok: 'RemoteOK', arbeitnow: 'Arbeitnow', jobicy: 'Jobicy' };
    return map[s] || s;
  }

  function getWorkType(location, source, tags) {
    const loc = (location || '').toLowerCase();
    const allTags = (tags || []).map(t => t.toLowerCase()).join(' ');
    const combined = loc + ' ' + allTags;

    // RemoteOK and Jobicy are remote-first boards
    if (source === 'remoteok' || source === 'jobicy') return 'remote';

    // Check for hybrid indicators
    if (combined.includes('hybrid')) return 'hybrid';

    // Check for remote indicators
    if (combined.includes('remote') || combined.includes('worldwide') || combined.includes('anywhere')) return 'remote';

    // Check for on-site indicators
    if (combined.includes('on-site') || combined.includes('onsite') || combined.includes('in-office')) return 'onsite';

    // Default: if has specific city/country, likely on-site
    if (loc && !loc.includes('remote') && loc.length > 2) return 'onsite';

    return 'remote'; // Default for job boards
  }

  function workTypeBadge(type) {
    const icons = {
      remote: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>',
      hybrid: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>',
      onsite: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>'
    };
    const labels = { remote: 'Remote', hybrid: 'Hybrid', onsite: 'On-site' };
    return `<span class="work-type ${type}">${icons[type]}${labels[type]}</span>`;
  }

  // ── Insights ──────────────────────────────────
  async function loadInsights() {
    try {
      const res = await q('job_listings', 'is_active=eq.true&select=tags,salary_min,salary_max,company,source');
      const all = await res.json();

      // Sources breakdown doughnut
      const srcCounts = {};
      all.forEach(l => { srcCounts[l.source] = (srcCounts[l.source] || 0) + 1; });
      renderDoughnut(srcCounts);
      document.querySelector('#stat-sources .stat-value').textContent = Object.keys(srcCounts).length;
      document.getElementById('hw-sources').textContent = `${Object.keys(srcCounts).length} / 3`;

      // Avg quality for hero widget
      const qualRes = await q('job_listings', 'is_active=eq.true&select=quality_score');
      const qualData = await qualRes.json();
      const avgQ = qualData.length ? Math.round(qualData.reduce((s, l) => s + (l.quality_score || 0), 0) / qualData.length) : 0;
      document.getElementById('hw-quality').textContent = `${avgQ} / 100`;

      // Companies
      const compCounts = {};
      all.forEach(l => { compCounts[l.company] = (compCounts[l.company] || 0) + 1; });
      document.querySelector('#stat-companies .stat-value').textContent = Object.keys(compCounts).length.toLocaleString();
      const topComp = Object.entries(compCounts).sort((a, b) => b[1] - a[1]).slice(0, 8);
      renderList('top-companies-list', topComp);

      // Tags — filter out generic/location terms that aren't skills
      const skipTags = new Set(['remote','remote work','worldwide','anywhere','full-time','part-time','contract','freelance','hybrid','onsite','on-site','other','n/a','intern','internship']);
      const tagCounts = {};
      all.forEach(l => (l.tags || []).forEach(t => { const k = t.toLowerCase().trim(); if (!skipTags.has(k) && k.length > 1) tagCounts[k] = (tagCounts[k] || 0) + 1; }));
      const topTags = Object.entries(tagCounts).sort((a, b) => b[1] - a[1]).slice(0, 8);
      renderList('top-tags-list', topTags);

      // Salary
      const bk = { '0–50k': 0, '50–80k': 0, '80–120k': 0, '120–160k': 0, '160–200k': 0, '200k+': 0 };
      all.forEach(l => {
        const s = l.salary_min || l.salary_max;
        if (!s) return;
        if (s < 50000) bk['0–50k']++;
        else if (s < 80000) bk['50–80k']++;
        else if (s < 120000) bk['80–120k']++;
        else if (s < 160000) bk['120–160k']++;
        else if (s < 200000) bk['160–200k']++;
        else bk['200k+']++;
      });
      renderSalary(bk);

      // Scrape history
      const hRes = await q('scrape_runs', 'status=eq.completed&order=started_at.desc&limit=30&select=source,started_at,quality_score,total_count,added_count,removed_count');
      const hist = await hRes.json();
      renderHistory(hist);
      if (hist.length) {
        const d = new Date(hist[0].started_at);
        const formatted = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        document.querySelector('#stat-latest .stat-value').textContent = formatted;
        document.getElementById('hw-refresh').textContent = formatted;
      }
    } catch (e) { console.error(e); }
  }

  function renderList(id, items) {
    const ul = document.getElementById(id);
    const isTags = id.includes('tags');
    ul.innerHTML = items.map(([label, count], i) =>
      `<li><span class="rank">${i + 1}</span><span class="label">${esc(isTags ? fmtTag(label) : titleCase(label))}</span><span class="value">${count}</span></li>`
    ).join('');
  }

  // Chart config
  const gridColor = 'rgba(255,255,255,0.04)';
  const tickColor = '#71717a';
  const baseOpts = {
    responsive: true, maintainAspectRatio: false,
    plugins: { legend: { display: false } },
    scales: {
      x: { ticks: { color: tickColor, font: { size: 11, family: 'Inter' } }, grid: { color: gridColor } },
      y: { ticks: { color: tickColor, font: { size: 11, family: 'Inter' } }, grid: { color: gridColor } },
    },
  };

  function renderDoughnut(srcCounts) {
    const ctx = document.getElementById('sources-doughnut');
    if (doughnutChart) doughnutChart.destroy();
    const labels = Object.keys(srcCounts).map(fmtSource);
    const colors = ['#6366f1', '#22c55e', '#f97316', '#06b6d4', '#a855f7'];
    doughnutChart = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels,
        datasets: [{ data: Object.values(srcCounts), backgroundColor: colors.slice(0, labels.length), borderWidth: 0, hoverOffset: 6 }],
      },
      options: {
        responsive: true, maintainAspectRatio: true, cutout: '65%',
        plugins: {
          legend: { display: true, position: 'bottom', labels: { color: tickColor, font: { size: 12, family: 'Inter' }, padding: 12, usePointStyle: true, pointStyleWidth: 8 } },
        },
      },
    });
  }

  function renderSalary(bk) {
    const ctx = document.getElementById('salary-chart');
    if (salaryChart) salaryChart.destroy();
    const gradient = ctx.getContext('2d').createLinearGradient(0, 0, 0, 250);
    gradient.addColorStop(0, 'rgba(34,197,94,0.5)');
    gradient.addColorStop(1, 'rgba(34,197,94,0.05)');
    salaryChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: Object.keys(bk),
        datasets: [{ data: Object.values(bk), backgroundColor: gradient, borderColor: 'rgba(34,197,94,0.6)', borderWidth: 1, borderRadius: 6 }],
      },
      options: baseOpts,
    });
  }

  function renderHistory(hist) {
    const ctx = document.getElementById('history-chart');
    if (historyChart) historyChart.destroy();
    const sorted = [...hist].reverse();
    historyChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: sorted.map(h => new Date(h.started_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })),
        datasets: [
          { label: 'Added', data: sorted.map(h => h.added_count), borderColor: '#22c55e', backgroundColor: 'rgba(34,197,94,0.08)', fill: true, tension: 0.4, pointRadius: 3, pointBackgroundColor: '#22c55e' },
          { label: 'Removed', data: sorted.map(h => h.removed_count), borderColor: '#ef4444', backgroundColor: 'rgba(239,68,68,0.08)', fill: true, tension: 0.4, pointRadius: 3, pointBackgroundColor: '#ef4444' },
        ],
      },
      options: { ...baseOpts, plugins: { legend: { display: true, labels: { color: tickColor, font: { size: 12, family: 'Inter' }, usePointStyle: true, pointStyleWidth: 8 } } } },
    });
  }

  // ── Init ──────────────────────────────────────
  (async () => {
    await initAuth();
    loadJobs();
    loadInsights();
    loadSuggestions().then(() => {
      setupAutocomplete('filter-role', 'role-suggestions', () => allRoles);
      setupAutocomplete('filter-location', 'location-suggestions', () => allLocations);
    });
  })();
})();
</script>
</body>
</html>
